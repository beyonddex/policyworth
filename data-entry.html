<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Data Entry — PolicyWorth</title>
  <link rel="stylesheet" href="/css/styles.css" />

  <!-- Auth bootstrap (must load before data-entry.js since it imports from /js/auth.js) -->
  <script type="module" src="/js/auth.js"></script>
  <script type="module" src="/js/nav-auth.js"></script>
  <script type="module">
    /* Auth guard: require login */
    import { auth } from '/js/auth.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        const next = encodeURIComponent(window.location.pathname);
        window.location.href = `/login.html?next=${next}`;
      }
    });
  </script>

  <style>
    /* Light form polish to match our Apple-ish theme */
    .form-grid { display:grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap:14px; }
    .form-grid .span-1 { grid-column: span 1 / span 1; }
    .form-grid .span-2 { grid-column: span 2 / span 2; }
    .form-grid .span-3 { grid-column: span 3 / span 3; }
    .form-grid .span-6 { grid-column: 1 / -1; }
    label span { font-size:12px; color:#6b7280; display:block; margin-bottom:6px; }
    input, select { width:100%; height:40px; padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:#fff; }
    input[type="number"] { text-align:right; }
    .actions { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .table { width:100%; border-collapse:collapse; }
    .table th, .table td { padding:12px 10px; border-top:1px solid var(--border); }
    .table th { text-align:left; font-weight:600; color:#6b7280; }
    .table tr:hover td { background:#fafafa; }
    .muted { color:#6b7280; }
    .hint { font-size:12px; color:#6b7280; margin-top:4px; }

    /* Page layout with right sidebar */
    .page-grid { display:grid; grid-template-columns: 1fr 360px; gap:16px; align-items:start; }
    @media (max-width: 980px) { .page-grid { grid-template-columns: 1fr; } }

    /* Read-only look for mirrored cost field */
    .readonly { background:#f9fafb; color:#6b7280; }

    /* Saved locations list */
    .saved-header { display:flex; align-items:center; gap:8px; }
    .saved-count { font-size:12px; color:#6b7280; }
    .saved-list { display:flex; flex-direction:column; gap:6px; max-height:260px; overflow:auto; margin-top:8px; }
    .saved-item {
      display:flex; justify-content:space-between; align-items:center; gap:8px;
      border:1px solid var(--border); border-radius:10px; padding:8px 10px; background:#fff; cursor:pointer;
    }
    .saved-item:hover { background:#fafafa; }
    .saved-item .name { font-weight:600; }
    .saved-item .sub { font-size:12px; color:#6b7280; }
    .saved-item .row-right { display:flex; align-items:center; gap:8px; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; }

    /* Active highlight for current saved location (blue outline) */
    .saved-item.active {
      border-color:#3b82f6;
      box-shadow:0 0 0 2px rgba(59,130,246,0.15);
      background:#f8fbff;
    }

    /* Small "x" icon button */
    .icon-btn {
      display:inline-flex; align-items:center; justify-content:center;
      width:26px; height:26px; border:1px solid var(--border); border-radius:6px; background:#fff;
      font-weight:700; line-height:1; cursor:pointer;
    }
    .icon-btn:hover { background:#f3f4f6; }
  </style>
</head>
<body>
  <noscript>
    <div class="container" style="padding:16px">
      <div class="card">JavaScript is required for Data Entry.</div>
    </div>
  </noscript>

  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="/"><span class="brand-mark">PW</span><span class="brand-name">PolicyWorth</span></a>
      <nav class="nav"><ul>
        <li><a class="link" href="/index.html">Home</a></li>
        <!-- Gated links use data-href; nav-auth.js injects real href after login -->
        <li><a class="link" data-gated data-href="/dashboard.html" title="Login to access">Dashboard</a></li>
        <li><a class="link" data-gated data-href="/survey.html" title="Login to access">Survey</a></li>

        <!-- Current page stays a normal link -->
        <li><a class="link" href="/data-entry.html" aria-current="page">Data Entry</a></li>

        <li><a class="link" data-gated data-href="/reports.html" title="Login to access">Reports</a></li>
        <!-- Admin-only + gated -->
        <li><a class="link" data-gated data-admin-only="true" data-href="/settings.html" title="Admins only">Settings</a></li>
      </ul></nav>
      <div class="auth"></div>
    </div>
  </header>

  <main class="container" style="padding:32px 20px 56px">
    <div class="page-grid">
      <!-- LEFT COLUMN -->
      <div>
        <!-- Add tally card -->
        <section class="card" style="margin-bottom:20px">
          <div class="eyebrow">Add tally</div>
          <form id="tallyForm" class="form-grid" autocomplete="off">
            <label>
              <span>Date</span>
              <input id="date" name="date" type="date" required />
            </label>

            <label class="span-2">
              <span>State</span>
              <select id="state" name="state" required></select>
            </label>

            <label class="span-3">
              <span>County</span>
              <select id="county" name="county" required disabled>
                <option value="">Select a state first</option>
              </select>
            </label>

            <label class="span-3">
              <span>Service</span>
              <!-- Values are codes (stored); labels are human-friendly (shown). -->
              <select id="service" name="service" required>
                <option value="case_mgmt">Case Management</option>
                <option value="hdm">Home-Delivered Meals</option>
                <option value="caregiver_respite">Caregiver/Respite</option>
                <option value="crisis_intervention">Crisis Intervention</option>
              </select>
            </label>

            <!-- Mirrored (read-only) cost for the selected service -->
            <label class="span-3">
              <span>Average Cost / Year (selected service)</span>
              <input
                id="avgCostYear"
                name="avgCostYear"
                type="number"
                min="0"
                step="1"
                value="0"
                readonly
                aria-readonly="true"
                class="readonly"
                title="Edit location-specific costs in the right sidebar"
              />
              <div class="hint">Auto-filled from the location costs on the right.</div>
            </label>

            <label>
              <span>Yes</span>
              <input id="yes" name="yes" type="number" min="0" step="1" value="0" required />
            </label>

            <label>
              <span>No</span>
              <input id="no" name="no" type="number" min="0" step="1" value="0" required />
            </label>

            <div class="actions span-6" style="margin-top:6px">
              <button class="btn btn--primary" type="submit">Save</button>
              <div id="msg" class="muted" aria-live="polite"></div>
            </div>
          </form>
        </section>

        <!-- Recent entries card -->
        <section class="card">
          <div class="eyebrow">Recent entries</div>
          <div class="muted" id="emptyState" style="display:none; margin:6px 0 10px">No entries yet.</div>

          <div class="table-wrap" style="overflow:auto">
            <table class="table" id="entriesTable">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>State</th>
                  <th>County</th>
                  <th>Service</th>
                  <th>Avg Cost / Year</th>
                  <th>Yes</th>
                  <th>No</th>
                  <th>Added</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="muted" id="limitNote" style="margin-top:8px">Showing latest 50.</div>
        </section>
      </div>

      <!-- RIGHT COLUMN -->
      <aside>
        <!-- Location-specific cost editor -->
        <section class="card">
          <div class="eyebrow">Location-specific Costs (Annual)</div>
          <p class="muted" style="margin-top:6px">
            Track the annual cost per person for each service <em>by state & county</em>. If a service is funded by private philanthropy, enter <strong>$0</strong>.
          </p>

          <!-- Controls to pick which location to edit -->
          <div class="form-grid" style="align-items:end; margin-top:8px">
            <label class="span-2">
              <span>State</span>
              <select id="costState" aria-label="Costs: select state"></select>
            </label>

            <label class="span-3">
              <span>County</span>
              <select id="costCounty" aria-label="Costs: select county">
                <option value="">Select a state first</option>
              </select>
            </label>

            <!-- Reset replaces the old "Use current" -->
            <div class="span-1" style="align-self:end">
              <button id="costResetBtn" type="button" class="btn" style="width:100%; white-space:nowrap" title="Reset all four costs for this county to $0">
                Reset
              </button>
            </div>
          </div>

          <!-- Four service cost fields for the chosen location -->
          <!-- Wrap in a form so pressing Enter in any field submits (saves) -->
          <form id="locCostsForm" class="form-grid" style="margin-top:10px">
            <label class="span-6">
              <span>Case Management — $ / year</span>
              <input id="loc_cost_case_mgmt" type="number" min="0" step="1" placeholder="e.g. 17000" value="0" data-clear-zero />
            </label>

            <label class="span-6">
              <span>Home-Delivered Meals — $ / year</span>
              <input id="loc_cost_hdm" type="number" min="0" step="1" placeholder="e.g. 12000" value="0" data-clear-zero />
            </label>

            <label class="span-6">
              <span>Caregiver/Respite — $ / year</span>
              <input id="loc_cost_caregiver_respite" type="number" min="0" step="1" placeholder="0 if privately funded" value="0" data-clear-zero />
            </label>

            <label class="span-6">
              <span>Crisis Intervention — $ / year</span>
              <input id="loc_cost_crisis_intervention" type="number" min="0" step="1" placeholder="0 if privately funded" value="0" data-clear-zero />
            </label>

            <div class="actions span-6" style="margin-top:10px">
              <button class="btn btn--primary" id="costSaveBtn" type="submit">Save location costs</button>
              <div id="costsMsg" class="muted" aria-live="polite"></div>
            </div>
          </form>
        </section>

        <!-- Navigator of saved locations -->
        <section class="card" style="margin-top:16px">
          <div class="eyebrow saved-header">
            Saved locations
            <span id="savedCount" class="saved-count"></span>
          </div>

          <div class="form-grid" style="margin-top:8px">
            <label class="span-6">
              <span>Filter</span>
              <input id="costFilter" type="search" placeholder="Search by county or state…" />
            </label>
          </div>

          <div id="savedList" class="saved-list" aria-live="polite">
            <!-- data-entry.js will render saved items like:
              <div class="saved-item" data-state="Florida" data-county="Sarasota" role="button" tabindex="0">
                <div>
                  <div class="name">Sarasota</div>
                  <div class="sub">Florida</div>
                </div>
                <div class="row-right">
                  <span class="pill">$ per-year set</span>
                  <button class="icon-btn" data-del aria-label="Delete saved location">&times;</button>
                </div>
              </div>
              (Apply class "active" to highlight the currently selected location)
            -->
          </div>
        </section>

        <p class="muted" style="margin-top:8px">
          Note: Location costs are private to your account and auto-fill the “Avg Cost / Year” on the left when you select a state, county, and service.
        </p>
      </aside>
    </div>
  </main>

  <!-- data-entry.js handles:
       - loading /data/states-counties.json
       - remembering last state + county + service (per user)
       - Firestore write to users/{uid}/tallies and live table (server-side sorted)
       - per-user, per-location service cost editor + saved locations navigator
       - enter-to-save, zero-on-blur, reset, delete saved location, and active highlight -->
  <script type="module" src="/js/data-entry.js"></script>
</body>
</html>
