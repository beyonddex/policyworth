<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Settings — PolicyWorth</title>
  <link rel="stylesheet" href="/css/styles.css" />

  <!-- Core auth + navbar gating -->
  <script type="module" src="/js/auth.js"></script>
  <script type="module" src="/js/nav-auth.js"></script>

  <style>
    /* Layout helpers to match the global theme */
    .form-grid { display:grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap:14px; }
    .form-grid .span-2 { grid-column: span 2 / span 2; }
    .form-grid .span-3 { grid-column: span 3 / span 3; }
    .form-grid .span-6 { grid-column: 1 / -1; }
    label span { font-size:12px; color:#6b7280; display:block; margin-bottom:6px; }
    input, select, textarea { width:100%; padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:#fff; }
    textarea { min-height: 64px; }
    .actions { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .muted { color:#6b7280; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; }
    .danger { color:#b91c1c; }

    /* Tables */
    .table-wrap { overflow:auto; }
    .table { width:100%; border-collapse:collapse; }
    .table th, .table td { padding:12px 10px; border-top:1px solid var(--border); vertical-align:top; }
    .table th { text-align:left; font-weight:600; color:#6b7280; white-space:nowrap; }
    .table tr:hover td { background:#fafafa; }
    .row-actions { display:flex; gap:8px; align-items:center; justify-content:flex-end; }
    .row-dirty td { background:#fcf7ed !important; } /* highlight unsaved rows */

    /* Section spacing */
    .section { margin-top: 22px; }
    .section h3 { margin: 0 0 6px; }
    .section .muted { margin: 2px 0 10px; }
  </style>
</head>

<!-- Page-level guard; nav-auth.js will redirect if not signed in -->
<body data-requires-auth="true">
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="/"><span class="brand-mark">PW</span><span class="brand-name">PolicyWorth</span></a>
      <nav class="nav">
        <ul>
          <li><a class="link" href="/index.html">Home</a></li>
          <li><a class="link link--gated" href="/dashboard.html">Dashboard</a></li>
          <li><a class="link link--gated" href="/survey.html">Survey</a></li>
          <li><a class="link link--gated" href="/data-entry.html">Data Entry</a></li>
          <li><a class="link link--gated link--admin" data-admin-only="true" href="/settings.html" aria-current="page">Settings</a></li>
        </ul>
      </nav>
      <div class="auth"></div>
    </div>
  </header>

  <main class="container" style="padding:32px 20px 56px">
    <!-- Forbidden (shown if not admin) -->
    <section id="forbidden" class="card" style="display:none">
      <div class="eyebrow">Restricted</div>
      <p class="muted">Admins only. If you believe this is a mistake, contact an administrator.</p>
    </section>

    <!-- Settings (admins only) -->
    <section id="adminWrap" class="card" style="display:none">
      <div class="eyebrow">Admin Settings</div>
      <p class="muted" style="margin-top:4px">
        These values feed your calculations on <strong>Reports</strong>. Only admins can edit.
      </p>

      <!-- ========== PARAMETERS ========== -->
      <div class="section">
        <h3>Parameters</h3>
        <p class="muted">
          Key/value pairs used inside equations (e.g., <code>RATE_HDM</code>, <code>THRESHOLD</code>). Numbers are stored as numbers.
        </p>

        <div class="table-wrap">
          <table class="table" aria-label="Parameters table">
            <thead>
              <tr>
                <th style="width:28%">Key</th>
                <th style="width:18%">Type</th>
                <th>Value</th>
                <th style="width:60px"></th>
              </tr>
            </thead>
            <tbody id="paramsTbody"></tbody>
          </table>
        </div>
        <div class="actions" style="margin-top:10px">
          <button class="btn" id="addParamBtn" type="button">Add parameter</button>
          <span class="muted">Keys are UPPER_CASE with underscores.</span>
        </div>
      </div>

      <!-- ========== EQUATIONS ========== -->
      <div class="section">
        <h3>Equations</h3>
        <p class="muted">
          Each equation has a label and an expression. Expressions can reference your <code>params</code> and will be evaluated in Reports.
          Example: <code>(yes - no) * param('RATE_HDM')</code> or <code>countyCost(state, county, 'seniorSpending')</code>
        </p>

        <div id="eqList" aria-live="polite"></div>
        <div class="actions" style="margin-top:10px">
          <button class="btn" id="addEqBtn" type="button">Add equation</button>
        </div>
      </div>

      <!-- ========== COUNTY DATA ========== -->
      <div class="section">
        <h3>County-Specific Data (Yearly $)</h3>
        <p class="muted">
          These values are used when computing costs and impacts in reports. Pick a state, add counties, and enter the
          <strong>yearly</strong> values:
          <br>• <strong>Nursing-home Cost</strong>: Average annual cost per resident
          <br>• <strong>Senior Local Spending</strong>: Average annual local spending by seniors
          <br>• <strong>Average Stay Duration</strong>: Average years a senior remains at home with services
          <br>You can also record a data source and effective year (e.g., "Genworth 2024").
        </p>

        <!-- Controls row -->
        <div class="form-grid" style="align-items:end">
          <label class="span-2">
            <span>State</span>
            <select id="ccState" aria-label="Select state"></select>
          </label>

          <label class="span-3">
            <span>Add county</span>
            <select id="ccAddCountySel" aria-label="Select county to add"></select>
          </label>

          <div>
            <button id="ccAddBtn" type="button" class="btn" style="width:100%">Add</button>
          </div>

          <label class="span-2" style="margin-top:6px">
            <span>Filter counties</span>
            <input id="ccFilter" type="search" placeholder="Type to filter…" />
          </label>
        </div>

        <!-- Table -->
        <div class="table-wrap" style="margin-top:10px">
          <table class="table" aria-label="County data table">
            <thead>
              <tr>
                <th>County</th>
                <th style="width:140px">Nursing-home ($ / year)</th>
                <th style="width:140px">Senior Spending ($ / year)</th>
                <th style="width:120px">Avg Stay (years)</th>
                <th>Source</th>
                <th style="width:100px">Year</th>
                <th style="width:60px"></th>
              </tr>
            </thead>
            <tbody id="ccTbody"></tbody>
          </table>
        </div>

        <div class="actions" style="margin-top:10px">
          <button id="ccSaveBtn" type="button" class="btn btn--primary">Save changes</button>
          <div id="ccMsg" class="muted" aria-live="polite"></div>
        </div>

        <p class="muted" style="margin-top:6px">
          Tip: Unsaved rows are lightly highlighted. Click <strong>Save changes</strong> to write updates to Firestore.<br>
          <strong>Usage in equations:</strong> Access these values using <code>getCounty(state, county, 'nhYearly')</code>, <code>getCounty(state, county, 'seniorSpending')</code>, or <code>getCounty(state, county, 'avgStayDuration')</code>
        </p>
      </div>

      <!-- Action bar (for params/equations) -->
      <div class="actions" style="margin-top:16px">
        <button class="btn btn--primary" id="saveBtn" type="button">Save</button>
        <button class="btn" id="revertBtn" type="button">Revert</button>
        <div id="msg" class="muted" aria-live="polite"></div>
      </div>
    </section>
  </main>

  <script type="module" src="/js/settings.js"></script>
</body>
</html>