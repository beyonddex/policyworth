<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard â€” PolicyWorth</title>
  <link rel="stylesheet" href="/css/styles.css" />

  <!-- Auth bootstrap -->
  <script type="module" src="/js/auth.js"></script>
  <script type="module" src="/js/nav-auth.js"></script>
  <script type="module">
    /* Auth guard: require login */
    import { auth } from '/js/auth.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        const next = encodeURIComponent(window.location.pathname);
        window.location.href = `/login.html?next=${next}`;
      }
    });
  </script>
  
  <style>
    /* Dashboard-specific styles */
    :root {
      --pw-ink: #0b1220;
      --pw-text: #2a3342;
      --pw-muted: #6b7280;
      --pw-line: #e6e9ee;
      --pw-accent: #0a84ff;
      --pw-green: #12b981;
      --pw-radius-lg: 18px;
      --pw-shadow-1: 0 2px 6px rgba(10,12,16,.05), 0 10px 30px rgba(10,12,16,.06);
      --pw-shadow-2: 0 12px 40px rgba(10,12,16,.10);
      --pw-glass: rgba(255,255,255,.72);
    }
    
    /* Apple-style gradient background */
    body.pw-dashboard {
      background:
        radial-gradient(800px 380px at 15% -10%, rgba(10,132,255,.08), transparent 60%),
        radial-gradient(700px 380px at 85% -20%, rgba(18,185,129,.10), transparent 60%),
        #fbfcfe;
    }
    
    .pw-container {
      max-width: 1080px;
      margin: 0 auto;
      padding: 48px 28px 80px;
    }
    
    /* Hero section */
    .pw-hero {
      margin: 6px 0 24px;
    }
    .pw-title {
      font-size: clamp(30px, 4.4vw, 40px);
      font-weight: 900;
      letter-spacing: -0.02em;
      color: var(--pw-ink);
      margin: 0;
    }
    .pw-subtitle {
      color: var(--pw-muted);
      font-size: 15px;
      margin-top: 6px;
    }
    
    /* Buttons */
    .pw-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      padding: 12px 18px;
      box-shadow: var(--pw-shadow-1);
      transition: transform .06s ease, box-shadow .18s ease, background .18s ease;
      border: none;
      font-weight: 700;
      cursor: pointer;
      font-size: 15px;
    }
    .pw-btn.primary {
      background: linear-gradient(180deg, #0b86ff, #0776e8);
      color: #fff;
      border: 1px solid rgba(0,0,0,.04);
    }
    .pw-btn.primary:hover {
      transform: translateY(-1px);
      box-shadow: var(--pw-shadow-2);
      filter: brightness(1.02);
    }
    .pw-btn.ghost {
      background: #fff;
      border: 1px solid var(--pw-line);
      color: var(--pw-ink);
    }
    .pw-btn.ghost:hover {
      background: #f3f6fb;
      transform: translateY(-1px);
      box-shadow: var(--pw-shadow-2);
    }
    
    /* Filter/Report Builder */
    .pw-filter {
      background: rgba(255,255,255,.88);
      backdrop-filter: saturate(1.1) blur(10px);
      border: 1px solid var(--pw-line);
      border-radius: var(--pw-radius-lg);
      box-shadow: var(--pw-shadow-2);
      padding: 22px;
      margin-bottom: 24px;
    }
    
    .eyebrow {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--pw-muted);
      margin-bottom: 12px;
      font-weight: 600;
    }
    
    .pw-controls {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(12, minmax(0,1fr));
    }
    
    .pw-field {
      grid-column: span 3;
      min-width: 0;
    }
    .pw-field.wide {
      grid-column: span 6;
    }
    .pw-field.full {
      grid-column: 1 / -1;
    }
    
    .pw-label {
      display: block;
      margin-bottom: 6px;
      color: var(--pw-muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .06em;
      font-weight: 600;
    }
    
    .pw-input, .pw-select {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--pw-line);
      border-radius: 14px;
      background: #fff;
      font-size: 15px;
      box-shadow: var(--pw-shadow-1);
      outline: none;
    }
    .pw-input:focus, .pw-select:focus {
      border-color: #b9d8ff;
      box-shadow: 0 0 0 4px rgba(10,132,255,.18);
    }
    
    /* Service chips */
    .svc-chips {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(4, minmax(0,1fr));
    }
    .svc-chip {
      position: relative;
      display: block;
    }
    .svc-chip input {
      position: absolute;
      inset: 0;
      opacity: 0;
      pointer-events: none;
    }
    .svc-chip span {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 42px;
      padding: 0 14px;
      border: 1px solid var(--pw-line);
      border-radius: 14px;
      background: #fff;
      font-weight: 600;
      color: var(--pw-text);
      box-shadow: var(--pw-shadow-1);
      transition: .18s;
    }
    .svc-chip span:hover {
      border-color: #cfe6dc;
      box-shadow: 0 0 0 4px rgba(18,185,129,.12) inset;
    }
    .svc-chip input:checked + span {
      background: #f2fbf7;
      border-color: #b8e6d5;
      color: #0e7e57;
    }
    
    .pw-actions {
      grid-column: 1 / -1;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 10px;
    }
    
    /* Cards */
    .pw-card {
      background: #fff;
      border: 1px solid var(--pw-line);
      border-radius: var(--pw-radius-lg);
      box-shadow: var(--pw-shadow-2);
      padding: 32px;
      margin-top: 16px;
    }
    
    .pw-card .title {
      font-size: clamp(18px, 2.2vw, 22px);
      font-weight: 800;
      letter-spacing: -0.01em;
      color: var(--pw-ink);
    }
    
    /* Seamless card grid - puzzle piece effect */
    .card-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0;
      margin-top: 16px;
      background: white;
      border: 1px solid var(--pw-line);
      border-radius: var(--pw-radius-lg);
      overflow: hidden;
      box-shadow: var(--pw-shadow-2);
    }
    
    .card-row .card-section {
      padding: 32px;
      position: relative;
    }
    
    .card-row .card-section + .card-section::before {
      content: '';
      position: absolute;
      left: 0;
      top: 24px;
      bottom: 24px;
      width: 1px;
      background: var(--pw-line);
    }
    
    /* Executive header - dark gradient */
    .exec-header {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border-radius: var(--pw-radius-lg);
      padding: 40px;
      margin-top: 24px;
      color: white;
      box-shadow: var(--pw-shadow-2);
    }
    
    .exec-header input {
      background: transparent;
      border: none;
      border-bottom: 1px solid rgba(255,255,255,.3);
      color: white;
      font-size: inherit;
      font-weight: inherit;
      outline: none;
      padding: 4px 0;
    }
    .exec-header input:focus {
      border-bottom-color: rgba(255,255,255,.8);
    }
    
    .org-title {
      font-size: clamp(24px, 3vw, 32px);
      font-weight: 700;
      margin-bottom: 12px;
    }
    
    .report-title {
      font-size: clamp(36px, 5vw, 48px);
      font-weight: 900;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }
    
    .report-subtitle {
      font-size: 18px;
      color: rgba(255,255,255,.8);
      margin-bottom: 32px;
    }
    
    .exec-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 48px;
      padding-top: 32px;
      border-top: 1px solid rgba(255,255,255,.2);
    }
    
    .exec-param {
      margin-bottom: 16px;
    }
    .exec-param label {
      display: block;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: rgba(255,255,255,.7);
      margin-bottom: 8px;
    }
    .exec-param input[type="number"],
    .exec-param input[type="range"] {
      width: 100%;
      padding: 12px;
      background: rgba(255,255,255,.1);
      border: 1px solid rgba(255,255,255,.2);
      border-radius: 12px;
      color: white;
      font-size: 16px;
      font-weight: 600;
    }
    .exec-param input:focus {
      background: rgba(255,255,255,.15);
      border-color: rgba(255,255,255,.5);
    }
    
    .range-value {
      text-align: center;
      margin-top: 8px;
      font-size: 18px;
      font-weight: 700;
    }
    
    .exec-metrics {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }
    
    .exec-metric {
      text-align: left;
    }
    .exec-metric-label {
      font-size: 12px;
      color: rgba(255,255,255,.7);
      margin-bottom: 4px;
    }
    .exec-metric-value {
      font-size: clamp(28px, 4vw, 36px);
      font-weight: 900;
    }
    
    /* Scenario cards */
    .scenarios {
      margin-top: 16px;
    }
    
    .scenario-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0;
      margin-bottom: 16px;
      background: white;
      border: 1px solid var(--pw-line);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--pw-shadow-2);
    }
    
    .scenario-card {
      padding: 28px;
      cursor: pointer;
      transition: all .2s ease;
      text-align: center;
      position: relative;
      border: none;
      background: white;
    }
    
    .scenario-card + .scenario-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 20px;
      bottom: 20px;
      width: 1px;
      background: var(--pw-line);
    }
    
    .scenario-card:hover {
      background: #f8fafb;
    }
    .scenario-card.active {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    .scenario-card.active::before {
      display: none;
    }
    
    .scenario-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .06em;
      font-weight: 600;
      margin-bottom: 8px;
      opacity: .7;
    }
    .scenario-card.active .scenario-label {
      opacity: .9;
    }
    
    .scenario-multiplier {
      font-size: 48px;
      font-weight: 900;
      letter-spacing: -0.02em;
    }
    
    .scenario-desc {
      background: #f8f9fa;
      border: 1px solid var(--pw-line);
      border-radius: 14px;
      padding: 20px;
      line-height: 1.6;
    }
    
    /* KPI Grid - seamless puzzle pieces */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0;
      margin-top: 16px;
      background: white;
      border: 1px solid var(--pw-line);
      border-radius: var(--pw-radius-lg);
      overflow: hidden;
      box-shadow: var(--pw-shadow-2);
    }
    
    .kpi-card {
      padding: 32px;
      position: relative;
      background: white;
      border: none;
    }
    
    .kpi-card + .kpi-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 24px;
      bottom: 24px;
      width: 1px;
      background: var(--pw-line);
    }
    
    .kpi-card.highlight {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    
    .kpi-card.highlight::before {
      display: none;
    }
    
    .kpi-card.highlight + .kpi-card::before {
      display: none;
    }
    
    .kpi-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: rgba(0,0,0,.05);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      font-size: 24px;
    }
    .kpi-card.highlight .kpi-icon {
      background: rgba(255,255,255,.2);
    }
    
    .kpi-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .06em;
      font-weight: 600;
      margin-bottom: 8px;
      opacity: .7;
    }
    
    .kpi-value {
      font-size: clamp(32px, 5vw, 42px);
      font-weight: 900;
      letter-spacing: -0.02em;
      margin-bottom: 4px;
    }
    
    .kpi-note {
      font-size: 13px;
      opacity: .7;
    }
    
    /* Charts - seamless side by side */
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0;
      margin-top: 16px;
      background: white;
      border: 1px solid var(--pw-line);
      border-radius: var(--pw-radius-lg);
      overflow: hidden;
      box-shadow: var(--pw-shadow-2);
    }
    
    .chart-card {
      padding: 32px;
      position: relative;
      border: none;
      background: white;
    }
    
    .chart-card + .chart-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 24px;
      bottom: 24px;
      width: 1px;
      background: var(--pw-line);
    }
    
    .chart-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--pw-ink);
      margin-bottom: 16px;
    }
    
    .chart-container {
      width: 100%;
      height: 320px;
      position: relative;
    }
    
    /* Print styles - SINGLE PAGE REPORT WITH 2-COLUMN LAYOUT */
    @media print {
      /* Hide interactive elements and dashboard-specific content */
      .site-header,
      .pw-filter, 
      .pw-actions, 
      .no-print,
      .pw-hero {
        display: none !important;
      }
      
      /* Hide model parameters section in print */
      .exec-header .exec-grid {
        display: none !important;
      }
      
      /* Reset background and optimize for print */
      body.pw-dashboard {
        background: white !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      
      .pw-container {
        max-width: 100%;
        width: 100%;
        padding: 0;
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto 1fr 1fr;
        gap: 14px 18px;
        padding: 0 30px;
        box-sizing: border-box;
      }
      
      /* Hide dashboard eyebrows in print */
      .eyebrow {
        display: none !important;
      }
      
      /* Executive header - full width at top (no parameters grid) */
      .exec-header {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        grid-column: 1 / -1;
        margin: 0;
        border-radius: 8px;
        padding: 22px 28px 20px;
        page-break-inside: avoid;
      }
      
      .org-title {
        font-size: 17pt;
        margin-bottom: 5px;
      }
      
      .report-title {
        font-size: 26pt;
        margin-bottom: 4px;
      }
      
      .report-subtitle {
        font-size: 13pt;
        margin-bottom: 0;
      }
      
      /* Executive Summary - left column, row 2 */
      .exec-header + .pw-card {
        grid-column: 1;
        grid-row: 2;
        margin: 0;
        padding: 16px 18px;
        border: 1px solid #d1d5db !important;
        border-radius: 8px;
        page-break-inside: avoid;
        overflow: visible;
      }
      
      .pw-card .title {
        font-size: 13pt;
        margin-bottom: 8px;
        color: #0b1220;
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 5px;
      }
      
      .pw-card p {
        font-size: 9pt;
        line-height: 1.45;
        margin: 0;
      }
      
      /* Scenario section - right column, row 2 */
      .scenarios {
        grid-column: 2;
        grid-row: 2;
        margin: 0;
        page-break-inside: avoid;
      }
      
      .scenarios .card-section {
        padding: 16px 18px;
        border: 1px solid #d1d5db !important;
        border-radius: 8px;
      }
      
      .scenarios .title {
        font-size: 13pt;
        margin-bottom: 8px;
        color: #0b1220;
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 5px;
      }
      
      .scenario-grid {
        margin-bottom: 8px;
      }
      
      .scenario-card {
        padding: 11px;
        border: 1px solid #d1d5db !important;
      }
      
      .scenario-label {
        font-size: 7.5pt;
        margin-bottom: 3px;
      }
      
      .scenario-multiplier {
        font-size: 26pt;
      }
      
      .scenario-desc {
        margin-top: 8px;
        padding: 10px;
        border: 1px solid #d1d5db !important;
        font-size: 7.5pt;
        line-height: 1.35;
      }
      
      /* Keep scenario and KPI card colors */
      .scenario-card.active,
      .kpi-card.highlight {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      
      /* KPI Grid - left column, row 3 */
      .kpi-grid {
        grid-column: 1;
        grid-row: 3;
        border: none !important;
        margin: 0;
        page-break-inside: avoid;
        overflow: visible;
      }
      
      .kpi-grid::before {
        content: "Key Performance Indicators";
        display: block;
        font-size: 13pt;
        font-weight: 700;
        margin-bottom: 8px;
        color: #0b1220;
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 5px;
      }
      
      .kpi-card {
        border: 1px solid #d1d5db !important;
        border-radius: 8px;
        padding: 14px !important;
        page-break-inside: avoid;
        overflow: visible;
      }
      
      .kpi-icon {
        width: 32px;
        height: 32px;
        font-size: 16px;
        margin-bottom: 8px;
      }
      
      .kpi-label {
        font-size: 7.5pt;
        margin-bottom: 5px;
      }
      
      .kpi-value {
        font-size: 20pt !important;
        margin-bottom: 3px;
      }
      
      .kpi-note {
        font-size: 6.5pt;
      }
      
      /* Charts section - right column, row 3 */
      .chart-grid {
        grid-column: 2;
        grid-row: 3;
        border: none !important;
        margin: 0;
        page-break-inside: avoid;
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
        overflow: visible;
      }
      
      .chart-grid::before {
        content: "Financial Projections";
        display: block;
        font-size: 13pt;
        font-weight: 700;
        margin-bottom: 8px;
        color: #0b1220;
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 5px;
        grid-column: 1 / -1;
      }
      
      .chart-card {
        border: 1px solid #d1d5db !important;
        border-radius: 8px;
        padding: 12px !important;
        page-break-inside: avoid;
        overflow: visible;
        box-sizing: border-box;
      }
      
      .chart-card + .chart-card::before {
        display: none !important;
      }
      
      .chart-title {
        font-size: 11pt;
        font-weight: 600;
        margin-bottom: 8px;
      }
      
      /* Chart containers - ensure proper sizing */
      .chart-container {
        height: 160px !important;
        width: 100% !important;
        position: relative !important;
        overflow: visible !important;
      }
      
      .chart-container canvas {
        max-width: 100% !important;
        max-height: 100% !important;
        width: 100% !important;
        height: 100% !important;
      }
      
      /* Ensure text is readable but compact */
      body {
        font-size: 9pt;
        line-height: 1.4;
        color: #000;
      }
      
      /* Hide card-row borders */
      .card-row {
        border: none !important;
        background: transparent !important;
        box-shadow: none !important;
        overflow: visible;
      }
      
      /* Tighter scenario grid */
      .scenario-grid {
        gap: 0;
        border: none !important;
        overflow: visible;
      }
      
      /* Page settings - remove browser headers/footers */
      @page {
        size: letter;
        margin: 0.45in 0.5in;
      }
      
      /* Force everything to stay on one page */
      .exec-header,
      .pw-card,
      .scenarios,
      .kpi-grid,
      .chart-grid,
      .chart-card {
        page-break-inside: avoid !important;
        page-break-after: avoid !important;
      }
      
      /* Ensure all containers are visible */
      * {
        overflow: visible !important;
      }
      
      /* Remove any potential page numbers or URLs */
      @page {
        @top-left { content: none; }
        @top-center { content: none; }
        @top-right { content: none; }
        @bottom-left { content: none; }
        @bottom-center { content: none; }
        @bottom-right { content: none; }
      }
    }
    
    /* Responsive */
    @media (max-width: 860px) {
      .pw-field {
        grid-column: 1 / -1;
      }
      .svc-chips {
        grid-template-columns: repeat(2, 1fr);
      }
      .exec-grid {
        grid-template-columns: 1fr;
      }
      .exec-metrics {
        grid-template-columns: 1fr;
      }
      .scenario-grid {
        grid-template-columns: 1fr;
      }
      .scenario-card + .scenario-card::before {
        display: none;
      }
      .scenario-card {
        border-top: 1px solid var(--pw-line);
      }
      .scenario-card:first-child {
        border-top: none;
      }
      .kpi-grid {
        grid-template-columns: 1fr;
      }
      .kpi-card + .kpi-card::before {
        display: none;
      }
      .kpi-card {
        border-top: 1px solid var(--pw-line);
      }
      .kpi-card:first-child {
        border-top: none;
      }
      .chart-grid {
        grid-template-columns: 1fr;
      }
      .chart-card + .chart-card::before {
        display: none;
      }
      .chart-card {
        border-top: 1px solid var(--pw-line);
      }
      .chart-card:first-child {
        border-top: none;
      }
      .card-row {
        grid-template-columns: 1fr;
      }
      .card-row .card-section + .card-section::before {
        display: none;
      }
      .card-row .card-section {
        border-top: 1px solid var(--pw-line);
      }
      .card-row .card-section:first-child {
        border-top: none;
      }
    }
  </style>
</head>
<body class="pw-dashboard">
  <noscript>
    <div class="container" style="padding:16px">
      <div class="card">JavaScript is required for the Dashboard.</div>
    </div>
  </noscript>

  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="/"><span class="brand-mark">PW</span><span class="brand-name">PolicyWorth</span></a>
      <nav class="nav"><ul>
        <li><a class="link" href="/index.html">Home</a></li>
        <!-- Current page -->
        <li><a class="link" href="/dashboard.html" aria-current="page">Dashboard</a></li>
        <li><a class="link" data-gated data-href="/survey.html" title="Login to access">Survey</a></li>
        <li><a class="link" data-gated data-href="/data-entry.html" title="Login to access">Data Entry</a></li>
        <!-- Admin-only + gated -->
        <li><a class="link" data-gated data-admin-only="true" data-href="/settings.html" title="Admins only">Settings</a></li>
      </ul></nav>
      <div class="auth"></div>
    </div>
  </header>

  <main class="pw-container">
    <!-- Hero -->
    <section class="pw-hero">
      <h1 class="pw-title">Impact Dashboard</h1>
      <p class="pw-subtitle">Economic modeling and projections for stakeholders</p>
    </section>
    
    <!-- Report Builder (No Print) -->
    <section class="pw-filter no-print">
      <div class="eyebrow">Report Builder</div>
      <div class="pw-controls">
        <label class="pw-field">
          <span class="pw-label">Period type</span>
          <select id="periodType" class="pw-select">
            <option value="quarter">Quarter</option>
            <option value="year">Annual</option>
            <option value="ytd">YTD</option>
            <option value="custom">Custom</option>
          </select>
        </label>
        
        <label class="pw-field" id="quarterField">
          <span class="pw-label">Quarter</span>
          <select id="quarter" class="pw-select">
            <option value="1">Q1</option>
            <option value="2">Q2</option>
            <option value="3">Q3</option>
            <option value="4" selected>Q4</option>
          </select>
        </label>
        
        <label class="pw-field" id="yearField">
          <span class="pw-label">Year</span>
          <select id="year" class="pw-select">
            <option value="2023">2023</option>
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
          </select>
        </label>
        
        <!-- Custom date range (hidden by default) -->
        <label class="pw-field" id="startDateField" style="display: none;">
          <span class="pw-label">Start Date</span>
          <input type="date" id="startDate" class="pw-input">
        </label>
        
        <label class="pw-field" id="endDateField" style="display: none;">
          <span class="pw-label">End Date</span>
          <input type="date" id="endDate" class="pw-input">
        </label>
        
        <div class="pw-field full">
          <span class="pw-label">Services (select all that apply)</span>
          <div id="services" class="svc-chips">
            <label class="svc-chip"><input type="checkbox" value="case_mgmt"><span>Case Management</span></label>
            <label class="svc-chip"><input type="checkbox" value="hdm"><span>Home-Delivered Meals</span></label>
            <label class="svc-chip"><input type="checkbox" value="caregiver_respite"><span>Caregiver / Respite</span></label>
            <label class="svc-chip"><input type="checkbox" value="crisis_intervention"><span>Crisis Intervention</span></label>
          </div>
        </div>
        
        <div class="pw-actions">
          <button id="generateBtn" class="pw-btn primary">Generate Report</button>
          <button id="exportBtn" class="pw-btn ghost">Export PDF</button>
        </div>
      </div>
    </section>
    
    <!-- Executive Header -->
    <section class="exec-header">
      <div class="org-title">
        <input type="text" id="orgName" value="Community Care Alliance" style="width: 100%; max-width: 400px;">
      </div>
      <div class="report-title">Economic Impact Report</div>
      <div class="report-subtitle">Community-Based Care Services</div>
      
      <div class="exec-grid">
        <!-- Left: Parameters -->
        <div>
          <h3 style="margin: 0 0 20px; font-size: 18px; opacity: .9;">Model Parameters</h3>
          <div class="exec-param">
            <label>Annual Services Provided</label>
            <input type="number" id="servicesProvided" value="250">
          </div>
          <div class="exec-param">
            <label>Avg Institutional Cost/Year</label>
            <input type="number" id="avgCost" value="15000">
          </div>
          <div class="exec-param">
            <label>Projection Period</label>
            <input type="range" id="yearsRange" min="1" max="10" value="5">
            <div class="range-value"><span id="yearsValue">5</span> years</div>
          </div>
        </div>
        
        <!-- Right: Metrics -->
        <div>
          <h3 style="margin: 0 0 20px; font-size: 18px; opacity: .9;">Key Metrics</h3>
          <div class="exec-metrics">
            <div class="exec-metric">
              <div class="exec-metric-label">Clients Served</div>
              <div class="exec-metric-value" id="clientsServed">250</div>
            </div>
            <div class="exec-metric">
              <div class="exec-metric-label">Total Impact</div>
              <div class="exec-metric-value" id="totalImpact">$3.75M</div>
            </div>
            <div class="exec-metric">
              <div class="exec-metric-label">ROI</div>
              <div class="exec-metric-value" id="roi">50%</div>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Executive Summary -->
    <section class="pw-card">
      <div class="eyebrow">Executive Summary</div>
      <div class="title" style="margin-bottom: 20px;">Impact Overview</div>
      <p style="line-height: 1.7; color: var(--pw-text); font-size: 15px;" id="execSummary">
        In fiscal year 2024, <strong>Community Care Alliance</strong> provided community-based care services to <strong>250 clients</strong>, preventing institutional placement and enabling individuals to age in place with dignity. Through our moderate economic model, these services generated an estimated <strong style="color: #10b981;">$3.75 million</strong> in total economic impact to taxpayers and the community.
      </p>
    </section>
    
    <!-- Care Scenarios -->
    <div class="card-row scenarios">
      <div class="card-section" style="grid-column: 1 / -1;">
        <div class="eyebrow">Economic Impact Methodology</div>
        <div class="title" style="margin-bottom: 20px;">Care Scenario Multipliers</div>
        
        <div class="scenario-grid">
          <div class="scenario-card" data-scenario="conservative" data-multiplier="1.25">
            <div class="scenario-label">Conservative</div>
            <div class="scenario-multiplier">1.25Ã—</div>
          </div>
          <div class="scenario-card active" data-scenario="moderate" data-multiplier="1.5">
            <div class="scenario-label">Moderate</div>
            <div class="scenario-multiplier">1.5Ã—</div>
          </div>
          <div class="scenario-card" data-scenario="comprehensive" data-multiplier="2.0">
            <div class="scenario-label">Comprehensive</div>
            <div class="scenario-multiplier">2.0Ã—</div>
          </div>
        </div>
        
        <div class="scenario-desc" id="scenarioDesc">
          <strong>Moderate Scenario Impact:</strong> Comprehensive home care with case management prevents institutional placement, reduces hospitalizations by 65%, enables medication management, and maintains family caregivers in the workforceâ€”creating secondary economic benefits averaging $45,000 per household annually in retained income and continued tax contributions.
        </div>
      </div>
    </div>
    
    <!-- KPIs -->
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-icon">ðŸ’°</div>
        <div class="kpi-label">Taxpayer Savings</div>
        <div class="kpi-value" id="baseSavings">$3.75M</div>
        <div class="kpi-note">Direct cost avoidance (NH - service cost)</div>
      </div>
      <div class="kpi-card highlight">
        <div class="kpi-icon">ðŸ“ˆ</div>
        <div class="kpi-label">Total Economic Impact</div>
        <div class="kpi-value" id="adjustedSavings">$5.63M</div>
        <div class="kpi-note" id="multiplierNote">Including multiplier effects (1.5Ã—)</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">ðŸ“…</div>
        <div class="kpi-label"><span id="projectionYears">5</span>-Year Projection</div>
        <div class="kpi-value" id="multiYear">$28.13M</div>
        <div class="kpi-note">Cumulative taxpayer savings projected</div>
      </div>
    </div>
    
    <!-- Charts -->
    <div class="chart-grid">
      <div class="chart-card">
        <div class="chart-title">Cumulative Economic Impact</div>
        <div class="chart-container">
          <canvas id="cumulativeChart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <div class="chart-title">Scenario Comparison</div>
        <div class="chart-container">
          <canvas id="comparisonChart"></canvas>
        </div>
      </div>
    </div>
  </main>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script type="module">
    import { auth, db } from '/js/auth.js';
    import { collection, query, where, getDocs, orderBy, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

    // Service labels mapping
    const SERVICE_LABELS = {
      case_mgmt: 'Case Management',
      hdm: 'Home-Delivered Meals',
      caregiver_respite: 'Caregiver/Respite',
      crisis_intervention: 'Crisis Intervention'
    };

    // ============================================
    // CONFIG & EQUATION SYSTEM
    // ============================================
    
    // Config data from Settings (params & equations)
    let configData = {
      params: {},
      equations: []
    };

    // County costs cache
    let countyCostsCache = {};

    // Equation results cache (for eq() function)
    let equationResultsCache = {};

    // Load config (parameters and equations) from Firestore
    async function loadConfig() {
      try {
        const configDoc = await getDoc(doc(db, 'config', 'app'));
        if (configDoc.exists()) {
          const data = configDoc.data();
          configData.params = data.params || {};
          configData.equations = data.equations || [];
          console.log('âœ… Loaded config:', {
            params: Object.keys(configData.params).length,
            equations: configData.equations.length
          });
        } else {
          console.warn('âš ï¸ No config document found');
        }
      } catch (error) {
        console.error('âŒ Error loading config:', error);
      }
    }

    // Load county costs
    async function loadCountyCosts() {
      try {
        const q = query(collection(db, 'countyCosts'));
        const snapshot = await getDocs(q);
        
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const key = `${data.state}__${data.county}`;
          countyCostsCache[key] = {
            nhYearly: data.nhYearly || 0,
            seniorSpending: data.seniorSpending || 0,
            avgStayDuration: data.avgStayDuration || 0,
            source: data.source || '',
            effectiveYear: data.effectiveYear || null
          };
        });
        
        console.log('âœ… Loaded county costs:', Object.keys(countyCostsCache).length, 'counties');
      } catch (error) {
        console.error('âŒ Error loading county costs:', error);
      }
    }

    // Helper: Get parameter
    function param(key) {
      const value = configData.params[key];
      if (value === undefined) {
        console.warn(`âš ï¸ Parameter '${key}' not found, returning 0`);
        return 0;
      }
      return typeof value === 'number' ? value : 0;
    }

    // Helper: Get county data
    function getCounty(state, countyName, field = 'nhYearly') {
      const key = `${state}__${countyName}`;
      const data = countyCostsCache[key];
      if (!data) {
        return null;
      }
      return data[field] !== undefined ? data[field] : null;
    }

    // Helper: Coalesce (first non-null, non-zero value)
    function coalesce(...values) {
      for (let val of values) {
        // Treat null, undefined, and 0 as "missing" - return first truthy value
        if (val !== null && val !== undefined && val !== 0) return val;
      }
      // If all values are null/undefined/0, return the last value
      return values[values.length - 1] || 0;
    }

    // Helper: Get equation result by ID or Label
    function eq(equationIdOrLabel) {
      // First try direct ID lookup
      let result = equationResultsCache[equationIdOrLabel];
      
      if (result !== undefined) {
        return result;
      }
      
      // If not found by ID, try finding by label
      // This allows using eq('TAXPAYER_SAVINGS') even if ID is 'abc123'
      const equation = configData.equations.find(eq => {
        if (!eq.label) return false;
        
        // Normalize both strings: uppercase, replace spaces/special chars with underscore
        const normalizedLabel = eq.label.toUpperCase().replace(/[^A-Z0-9]+/g, '_');
        const normalizedSearch = equationIdOrLabel.toUpperCase().replace(/[^A-Z0-9]+/g, '_');
        
        return normalizedLabel === normalizedSearch;
      });
      
      if (equation) {
        result = equationResultsCache[equation.id];
        if (result !== undefined) {
          console.log(`âœ… Matched equation '${equationIdOrLabel}' to '${equation.label}' (ID: ${equation.id})`);
          return result;
        }
      }
      
      console.warn(`âš ï¸ Equation '${equationIdOrLabel}' not found. Available equations:`, 
        configData.equations.map(e => `${e.label} (${e.id})`));
      return 0;
    }

    // Evaluate equation
    function evaluateEquation(expr, context) {
      try {
        const { yes, no, avgCostYear, state, county, service, periodFraction, nhYearly } = context;
        
        // Create a wrapper for the county lookup function to avoid name conflict
        const countyLookup = getCounty;
        
        // Create evaluation function with all helpers
        const func = new Function(
          'yes', 'no', 'avgCostYear', 'state', 'county', 'service', 'periodFraction', 'nhYearly',
          'param', 'countyLookup', 'coalesce', 'eq',
          `"use strict"; 
           // Make countyLookup available as 'county' function for equations
           const getCounty = countyLookup;
           return (${expr});`
        );
        
        const result = func(
          yes || 0,
          no || 0,
          avgCostYear || 0,
          state || '',
          county || '',
          service || '',
          periodFraction || 1,
          nhYearly,
          param,
          countyLookup,
          coalesce,
          eq
        );
        
        // Debug logging for first few tallies if Taxpayer Savings equation
        if (expr.includes('nhYearly') && window.debugTallyCount < 3) {
          window.debugTallyCount = (window.debugTallyCount || 0) + 1;
          console.log(`ðŸ” Tally #${window.debugTallyCount} Debug:`);
          console.log(`   County: ${state}, ${county}`);
          console.log(`   Clients (yes): ${yes}`);
          console.log(`   NH Cost: $${nhYearly ? nhYearly.toLocaleString() : 'null (using default)'}`);
          console.log(`   Service Cost: $${avgCostYear.toLocaleString()}`);
          console.log(`   Period Fraction: ${periodFraction.toFixed(3)}`);
          console.log(`   Calculation: ${yes} Ã— ($${nhYearly || param('DEFAULT_NH_YEARLY')} - $${avgCostYear}) Ã— ${periodFraction.toFixed(2)}`);
          console.log(`   Result: $${result.toLocaleString()}`);
        }
        
        // Debug logging for Total Economic Benefit equation
        if (expr.includes('avgStayDuration')) {
          console.log(`ðŸ” avgStayDuration Equation Debug:`);
          console.log(`   Expression: ${expr}`);
          console.log(`   State: '${state}'`);
          console.log(`   County: '${county}'`);
          const testLookup = countyLookup(state, county, 'avgStayDuration');
          console.log(`   getCounty result: ${testLookup}`);
          console.log(`   Coalesce result: ${testLookup !== null ? testLookup : 2.5}`);
          console.log(`   Final result: $${result.toLocaleString()}`);
        }
        
        return result;
      } catch (error) {
        console.error('âŒ Equation evaluation error:', expr, error);
        return 0;
      }
    }

    // Evaluate all equations
    function evaluateAllEquations(tallies, periodFraction = 1) {
      const results = {};
      
      // Initialize
      configData.equations.forEach(equation => {
        results[equation.id] = {
          id: equation.id,
          label: equation.label,
          expr: equation.expr,
          notes: equation.notes,
          total: 0,
          count: 0
        };
      });
      
      // Sort equations (ones without eq() first to handle dependencies)
      const sorted = [...configData.equations].sort((a, b) => {
        const aHasDep = a.expr.includes('eq(');
        const bHasDep = b.expr.includes('eq(');
        if (aHasDep && !bHasDep) return 1;
        if (!aHasDep && bHasDep) return -1;
        return 0;
      });
      
      // Clear cache for fresh calculation
      equationResultsCache = {};
      
      // Reset debug counter for tally-by-tally logging
      window.debugTallyCount = 0;
      
      // Evaluate each equation in dependency order
      sorted.forEach(equation => {
        let total = 0;
        let count = 0;
        
        // Check if equation uses eq() - these are ALWAYS aggregate equations
        const usesEq = equation.expr.includes('eq(');
        
        // Check if equation uses tally-specific variables
        // Note: Don't include 'getCounty' here - it can be used in both tally and aggregate equations
        const tallyVars = ['yes', 'no', 'avgCostYear'];
        const usesTallyVars = tallyVars.some(v => equation.expr.includes(v));
        
        // Classify: If it uses eq(), it's aggregate. Otherwise check for tally vars.
        const isPerTally = !usesEq && usesTallyVars;
        
        if (isPerTally) {
          // Evaluate per-tally and sum (for equations like Taxpayer Savings)
          tallies.forEach(tally => {
            // Get county NH cost if available
            const nhYearly = getCounty(tally.state, tally.county, 'nhYearly');
            
            const context = {
              yes: tally.yes || 0,
              no: tally.no || 0,
              avgCostYear: tally.avgCostYear || 0,
              state: tally.state || '',
              county: tally.county || '',
              service: tally.service || '',
              periodFraction,
              nhYearly
            };
            
            const value = evaluateEquation(equation.expr, context);
            
            if (!isNaN(value) && isFinite(value)) {
              total += value;
              count++;
            }
          });
        } else {
          // Evaluate once (for equations like Multiplied Savings that only use eq() and param())
          // Use first tally's state/county for county lookups (if available)
          let contextState = '';
          let contextCounty = '';
          let contextNhYearly = 0;
          
          if (tallies.length > 0) {
            contextState = tallies[0].state || '';
            contextCounty = tallies[0].county || '';
            contextNhYearly = getCounty(contextState, contextCounty, 'nhYearly') || 0;
            
            // Debug log for equations that use getCounty
            if (equation.expr.includes('getCounty')) {
              console.log(`ðŸ“ Aggregate equation using county data:`);
              console.log(`   Equation: ${equation.label}`);
              console.log(`   First tally state: '${tallies[0].state}'`);
              console.log(`   First tally county: '${tallies[0].county}'`);
              console.log(`   Context state: '${contextState}'`);
              console.log(`   Context county: '${contextCounty}'`);
            }
          }
          
          const context = {
            yes: 0,
            no: 0,
            avgCostYear: 0,
            state: contextState,
            county: contextCounty,
            service: '',
            periodFraction,
            nhYearly: contextNhYearly
          };
          
          total = evaluateEquation(equation.expr, context);
          count = 1;
        }
        
        results[equation.id].total = total;
        results[equation.id].count = tallies.length;  // Show total tallies, not just successful ones
        
        // Cache this result for use by other equations
        equationResultsCache[equation.id] = total;
        
        // Detailed logging
        const formatted = total >= 1000000 
          ? `$${(total / 1000000).toFixed(2)}M`
          : total >= 1000
          ? `$${(total / 1000).toFixed(1)}K`
          : `$${Math.round(total).toLocaleString()}`;
        
        console.log(`ðŸ“Š ${equation.label}: ${formatted}`);
        console.log(`   Expression: ${equation.expr}`);
        
        if (total === 0 && equation.expr.includes('eq(')) {
          console.warn(`   âš ï¸ Returned $0 but uses eq() - check if dependency equations exist!`);
        }
        
        if (total === 0 && equation.expr.includes('param(')) {
          const paramMatches = equation.expr.match(/param\(['"]([^'"]+)['"]\)/g);
          if (paramMatches) {
            paramMatches.forEach(match => {
              const paramName = match.match(/param\(['"]([^'"]+)['"]\)/)[1];
              const paramValue = param(paramName);
              console.warn(`   âš ï¸ Parameter '${paramName}' = ${paramValue}`);
            });
          }
        }
      });
      
      return results;
    }

    // ============================================
    // STATE & SCENARIOS
    // ============================================

    // State
    let state = {
      services: 250,
      avgCost: 15000,
      years: 5,
      multiplier: 1.5,
      scenario: 'moderate',
      currentUser: null,
      equationResults: null,
      periodFraction: 1,
      currentTallies: null  // Store tallies for re-evaluation when multiplier changes
    };
    
    const scenarios = {
      conservative: {
        multiplier: 1.25,
        label: 'Conservative Estimate',
        desc: 'Based on direct cost avoidance through prevention of institutional care placement and reduction in emergency medical services utilization. On average, clients remain at home with basic support services, avoiding $65,000+ annual institutional care costs.'
      },
      moderate: {
        multiplier: 1.5,
        label: 'Moderate Estimate',
        desc: 'Comprehensive home care with case management prevents institutional placement, reduces hospitalizations by 65%, enables medication management, and maintains family caregivers in the workforceâ€”creating secondary economic benefits averaging $45,000 per household annually in retained income and continued tax contributions.'
      },
      comprehensive: {
        multiplier: 2.0,
        label: 'Comprehensive Estimate',
        desc: 'Full-spectrum support including respite care, health monitoring, and social services. Prevents nursing home placement, reduces hospital costs by 80%, keeps caregivers employed (avg. $45K/year income retained), and creates community multiplier effects through local spending.'
      }
    };

    // Listen for auth state
    onAuthStateChanged(auth, (user) => {
      state.currentUser = user;
    });

    // ============================================
    // PERIOD & DATE HANDLING
    // ============================================

    // Period type handler - show/hide fields
    function updatePeriodFields() {
      const periodType = document.getElementById('periodType').value;
      const quarterField = document.getElementById('quarterField');
      const yearField = document.getElementById('yearField');
      const startDateField = document.getElementById('startDateField');
      const endDateField = document.getElementById('endDateField');

      // Reset all to hidden
      quarterField.style.display = 'none';
      yearField.style.display = 'block';
      startDateField.style.display = 'none';
      endDateField.style.display = 'none';

      switch(periodType) {
        case 'quarter':
          quarterField.style.display = 'block';
          yearField.style.display = 'block';
          break;
        case 'year':
          // Only year field visible (already set above)
          break;
        case 'ytd':
          yearField.style.display = 'block';
          break;
        case 'custom':
          startDateField.style.display = 'block';
          endDateField.style.display = 'block';
          yearField.style.display = 'none';
          break;
      }
    }

    // Initialize period field visibility
    document.getElementById('periodType').addEventListener('change', updatePeriodFields);
    updatePeriodFields();

    // Get date range based on period type
    function getDateRange() {
      const periodType = document.getElementById('periodType').value;
      const year = parseInt(document.getElementById('year').value);
      const quarter = parseInt(document.getElementById('quarter').value);
      
      let startDate, endDate;

      switch(periodType) {
        case 'quarter':
          const qtrStart = (quarter - 1) * 3; // 0, 3, 6, 9
          startDate = new Date(year, qtrStart, 1);
          endDate = new Date(year, qtrStart + 3, 0); // Last day of quarter
          break;
        
        case 'year':
          startDate = new Date(year, 0, 1);
          endDate = new Date(year, 11, 31);
          break;
        
        case 'ytd':
          startDate = new Date(year, 0, 1);
          endDate = new Date(); // Today
          break;
        
        case 'custom':
          const startInput = document.getElementById('startDate').value;
          const endInput = document.getElementById('endDate').value;
          if (!startInput || !endInput) {
            alert('Please select both start and end dates for custom range');
            return null;
          }
          startDate = new Date(startInput);
          endDate = new Date(endInput);
          break;
      }

      return { startDate, endDate };
    }

    // Get selected services
    function getSelectedServices() {
      const checkboxes = document.querySelectorAll('#services input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }

    // ============================================
    // DATA FETCHING & PROCESSING
    // ============================================

    // Fetch tallies from Firestore
    async function fetchTallies(startDate, endDate, services) {
      if (!state.currentUser) {
        console.error('No user logged in');
        return [];
      }

      try {
        const talliesRef = collection(db, 'users', state.currentUser.uid, 'tallies');
        
        // Build query
        let q = query(
          talliesRef,
          where('date', '>=', startDate.toISOString().split('T')[0]),
          where('date', '<=', endDate.toISOString().split('T')[0]),
          orderBy('date', 'desc')
        );

        const snapshot = await getDocs(q);
        const tallies = [];
        
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          // Filter by selected services if any
          if (services.length === 0 || services.includes(data.service)) {
            tallies.push({
              id: docSnap.id,
              ...data
            });
          }
        });

        console.log(`ðŸ“¥ Fetched ${tallies.length} tallies`);
        return tallies;
      } catch (error) {
        console.error('Error fetching tallies:', error);
        return [];
      }
    }

    // Aggregate data from tallies
    function aggregateTallies(tallies) {
      let totalYes = 0;
      let totalNo = 0;
      let totalCost = 0;
      let serviceCount = 0;
      const serviceCosts = {};
      const serviceCounts = {};

      tallies.forEach(tally => {
        totalYes += (tally.yes || 0);
        totalNo += (tally.no || 0);
        
        const cost = tally.avgCostYear || 0;
        if (cost > 0) {
          totalCost += cost;
          serviceCount++;
          
          // Track by service type for averaging
          if (!serviceCosts[tally.service]) {
            serviceCosts[tally.service] = 0;
            serviceCounts[tally.service] = 0;
          }
          serviceCosts[tally.service] += cost;
          serviceCounts[tally.service]++;
        }
      });

      // Calculate average cost
      const avgCost = serviceCount > 0 ? Math.round(totalCost / serviceCount) : 15000;
      
      return {
        servicesProvided: totalYes,
        avgCost: avgCost,
        totalYes,
        totalNo,
        totalTallies: tallies.length,
        serviceCosts,
        serviceCounts
      };
    }

    // ============================================
    // REPORT GENERATION
    // ============================================

    // Generate report from Firestore data
    async function generateReport() {
      const dateRange = getDateRange();
      if (!dateRange) return;

      const { startDate, endDate } = dateRange;
      const selectedServices = getSelectedServices();

      // Show loading state
      const btn = document.getElementById('generateBtn');
      const originalText = btn.textContent;
      btn.textContent = 'Loading...';
      btn.disabled = true;

      try {
        // Load config if not loaded
        if (Object.keys(configData.params).length === 0) {
          console.log('ðŸ“š Loading config and county costs...');
          await loadConfig();
          await loadCountyCosts();
        }

        // Fetch tallies
        const tallies = await fetchTallies(startDate, endDate, selectedServices);
        
        if (tallies.length === 0) {
          alert('No data found for the selected period and services. Please check your data entry or adjust the filters.');
          btn.textContent = originalText;
          btn.disabled = false;
          return;
        }

        // Store tallies for re-evaluation when multiplier changes
        state.currentTallies = tallies;

        // Aggregate data
        const aggregated = aggregateTallies(tallies);

        // Update state with aggregated data
        state.services = aggregated.servicesProvided;
        state.avgCost = aggregated.avgCost;

        // Calculate period fraction (for partial year calculations)
        const daysDiff = (endDate - startDate) / (1000 * 60 * 60 * 24);
        state.periodFraction = daysDiff / 365;
        console.log(`ðŸ“… Period fraction: ${state.periodFraction.toFixed(3)} (${Math.round(daysDiff)} days)`);

        // Evaluate equations if they exist
        if (configData.equations.length > 0) {
          console.log('ðŸ§® Evaluating equations...');
          const equationResults = evaluateAllEquations(tallies, state.periodFraction);
          state.equationResults = equationResults;
          
          console.log('âœ… Equation evaluation complete');
        } else {
          console.warn('âš ï¸ No equations found in config');
          state.equationResults = null;
        }

        // Update the model parameter inputs to show what was calculated
        document.getElementById('servicesProvided').value = state.services;
        document.getElementById('avgCost').value = state.avgCost;

        // Update UI
        updateUI();

        console.log('âœ… Report generated successfully', {
          period: `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`,
          services: selectedServices.length > 0 ? selectedServices.map(s => SERVICE_LABELS[s]).join(', ') : 'All services',
          tallies: tallies.length,
          clients: state.services,
          equations: state.equationResults ? Object.keys(state.equationResults).length : 0
        });

      } catch (error) {
        console.error('âŒ Error generating report:', error);
        console.error('Error stack:', error.stack);
        console.error('Error details:', {
          message: error.message,
          name: error.name,
          talliesCount: state.currentTallies?.length || 0,
          hasEquations: configData.equations?.length || 0,
          hasParams: Object.keys(configData.params || {}).length
        });
        alert(`Error generating report: ${error.message}\n\nCheck console for details.`);
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    // Generate button handler
    document.getElementById('generateBtn').addEventListener('click', generateReport);
    
    // ============================================
    // CALCULATIONS
    // ============================================

    // Calculate metrics
    function calculate() {
      // If we have equation results, use them
      if (state.equationResults) {
        // Look for specific equations by common patterns
        let taxpayerSavings = 0;
        let multipliedSavings = 0;
        let economicOutput = 0;

        Object.values(state.equationResults).forEach(result => {
          const label = (result.label || '').toLowerCase();
          
          if (label.includes('taxpayer') && label.includes('savings')) {
            taxpayerSavings = result.total;
          } else if (label.includes('multiplied') && label.includes('savings')) {
            multipliedSavings = result.total;
          } else if (label.includes('economic') && label.includes('output')) {
            economicOutput = result.total;
          }
        });

        // Use equation results if available
        const base = taxpayerSavings || (state.services * state.avgCost);
        const adjusted = multipliedSavings || (base * state.multiplier);
        const multi = adjusted * state.years;
        const roi = base > 0 ? (((adjusted / base) - 1) * 100).toFixed(0) : '0';
        
        console.log('ðŸ’° Using equation-based calculation:', {
          taxpayerSavings,
          multipliedSavings,
          economicOutput,
          base,
          adjusted,
          multi,
          roi
        });
        
        return { base, adjusted, multi, roi, economicOutput };
      }
      
      // Fallback to traditional calculation
      const base = state.services * state.avgCost;
      const adjusted = base * state.multiplier;
      const multi = adjusted * state.years;
      const roi = ((state.multiplier - 1) * 100).toFixed(0);
      
      return { base, adjusted, multi, roi, economicOutput: adjusted };
    }
    
    // ============================================
    // UI UPDATES
    // ============================================

    // Update UI
    function updateUI() {
      const { base, adjusted, multi, roi, economicOutput } = calculate();
      
      // Get actual values for display
      const taxpayerSavings = state.equationResults ? 
        Object.values(state.equationResults).find(r => r.label && r.label.toLowerCase().includes('taxpayer savings'))?.total || base :
        base;
      
      const multipliedSavings = state.equationResults ?
        Object.values(state.equationResults).find(r => r.label && r.label.toLowerCase().includes('multiplied savings'))?.total || adjusted :
        adjusted;
      
      const totalEconomicBenefit = state.equationResults ?
        Object.values(state.equationResults).find(r => r.label && r.label.toLowerCase().includes('total economic benefit'))?.total || multi :
        multi;
      
      // Get avgStayDuration for label
      let avgStay = 2.5; // default
      if (state.currentTallies && state.currentTallies.length > 0) {
        const firstTally = state.currentTallies[0];
        const countyStay = getCounty(firstTally.state, firstTally.county, 'avgStayDuration');
        if (countyStay && countyStay > 0) avgStay = countyStay;
      }
      
      document.getElementById('clientsServed').textContent = state.services.toLocaleString();
      document.getElementById('totalImpact').textContent = `$${(economicOutput / 1000000).toFixed(2)}M`;
      document.getElementById('roi').textContent = `${roi}%`;
      document.getElementById('baseSavings').textContent = `$${(multipliedSavings / 1000000).toFixed(2)}M`;
      document.getElementById('adjustedSavings').textContent = `$${(economicOutput / 1000000).toFixed(2)}M`;
      document.getElementById('multiYear').textContent = `$${(totalEconomicBenefit / 1000000).toFixed(2)}M`;
      document.getElementById('yearsValue').textContent = state.years;
      document.getElementById('multiplierNote').textContent = `Annual economic output`;
      
      // Update KPI labels to show Annual and Lifetime
      const kpiCards = document.querySelectorAll('.kpi-card');
      if (kpiCards.length >= 3) {
        // Card 1: Taxpayer Savings (with multiplier)
        kpiCards[0].querySelector('.kpi-label').textContent = 'Cost Avoidance';
        kpiCards[0].querySelector('.kpi-note').textContent = `Annual with ${state.multiplier}Ã— multiplier`;
        
        // Card 2: Total Economic Output
        kpiCards[1].querySelector('.kpi-label').textContent = 'Economic Output';
        kpiCards[1].querySelector('.kpi-note').textContent = 'Annual total benefit';
        
        // Card 3: Total Impact - update with actual avgStay
        const card3Label = kpiCards[2].querySelector('.kpi-label');
        card3Label.innerHTML = `Total Impact (${avgStay}y avg)`;
        kpiCards[2].querySelector('.kpi-note').textContent = `Lifetime economic benefit`;
      }
      
      // Display equation results if available
      displayEquationResults();
      
      // Determine the period description for the summary
      const periodType = document.getElementById('periodType').value;
      const year = document.getElementById('year').value;
      const quarter = document.getElementById('quarter').value;
      let periodDescription = '';

      switch(periodType) {
        case 'quarter':
          periodDescription = `Q${quarter} ${year}`;
          break;
        case 'year':
          periodDescription = `fiscal year ${year}`;
          break;
        case 'ytd':
          periodDescription = `year-to-date ${year}`;
          break;
        case 'custom':
          const startDate = document.getElementById('startDate').value;
          const endDate = document.getElementById('endDate').value;
          if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            periodDescription = `the period from ${start.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} to ${end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
          } else {
            periodDescription = 'the selected period';
          }
          break;
      }
      
      // Update exec summary with dynamic period
      const orgName = document.getElementById('orgName').value || 'Community Care Alliance';
      document.getElementById('execSummary').innerHTML = `
        In ${periodDescription}, <strong>${orgName}</strong> provided community-based care services to <strong>${state.services} clients</strong>, preventing institutional placement and enabling individuals to age in place with dignity. Through our ${scenarios[state.scenario].label.toLowerCase()}, these services generated an estimated <strong style="color: #10b981;">$${(economicOutput / 1000000).toFixed(2)} million</strong> in annual economic output to taxpayers and the community.
      `;
      
      updateCharts();
    }

    // Display equation results
    function displayEquationResults() {
      if (!state.equationResults || Object.keys(state.equationResults).length === 0) {
        const existing = document.getElementById('equationResultsDisplay');
        if (existing) existing.remove();
        return;
      }
      
      // Get equation values - use EXACT label matching to avoid conflicts
      const getEqValue = (label) => {
        // First try exact match (case-insensitive)
        const exactMatch = Object.values(state.equationResults).find(r => 
          r.label && r.label.toLowerCase() === label.toLowerCase()
        );
        if (exactMatch) return exactMatch.total;
        
        // Fallback to partial match (but warn)
        const partialMatch = Object.values(state.equationResults).find(r => 
          r.label && r.label.toLowerCase().includes(label.toLowerCase())
        );
        if (partialMatch) {
          console.warn(`âš ï¸ Using partial match for '${label}': found '${partialMatch.label}'`);
          return partialMatch.total;
        }
        
        return 0;
      };
      
      const taxpayerSavings = getEqValue('taxpayer savings');
      const multipliedSavings = getEqValue('multiplied savings');
      const seniorSpending = getEqValue('senior local spending');
      const fedTax = getEqValue('fed tax');
      const stateTax = getEqValue('state tax');
      const localTax = getEqValue('local tax');
      const totalTaxes = getEqValue('total taxes');
      const totalEconomicBenefit = getEqValue('total economic benefit');
      const economicOutput = getEqValue('economic output');
      
      // DEBUG: Log what we got from equations
      console.log('ðŸ” EQUATION VALUES DEBUG:');
      console.log('  Taxpayer Savings:', taxpayerSavings);
      console.log('  Multiplied Savings:', multipliedSavings);
      console.log('  Senior Spending:', seniorSpending);
      console.log('  Total Taxes:', totalTaxes);
      console.log('  Economic Output:', economicOutput);
      console.log('  Total Economic Benefit:', totalEconomicBenefit);
      console.log('  State.services (seniors):', state.services);
      console.log('  All equation results:', state.equationResults);
      
      // DEBUG: Check what's actually in the results for Total Economic Benefit
      const tebResult = Object.values(state.equationResults).find(r => 
        r.label && r.label.toLowerCase().includes('total economic benefit')
      );
      console.log('  ðŸ”Ž Total Economic Benefit result object:', tebResult);
      
      // Get actual avgStayDuration from first tally's county data
      let avgStay = 2.5; // default
      if (state.currentTallies && state.currentTallies.length > 0) {
        const firstTally = state.currentTallies[0];
        const countyStay = getCounty(firstTally.state, firstTally.county, 'avgStayDuration');
        if (countyStay && countyStay > 0) avgStay = countyStay;
      }
      
      // Format helpers
      const fmt = (val) => {
        if (val >= 1000000) return `$${(val / 1000000).toFixed(2)}M`;
        if (val >= 1000) return `$${(val / 1000).toFixed(0)}K`;
        return `$${Math.round(val).toLocaleString()}`;
      };
      
      const fmtLong = (val) => `$${Math.round(val).toLocaleString()}`;
      const perSenior = state.services || 1;
      
      // Calculate correct per-senior values
      // For full annual periods, show annualized rates
      // For quarters/YTD/custom, show pro-rated actual rates for that specific period
      const periodType = document.getElementById('periodType')?.value || 'year';
      const shouldAnnualize = (periodType === 'year');
      
      let perSeniorSavings, perSeniorSpending;
      
      if (shouldAnnualize) {
        // Annualized (what it would be for a full year)
        perSeniorSavings = Math.round((taxpayerSavings / perSenior) / state.periodFraction);
        perSeniorSpending = Math.round((seniorSpending / perSenior) / state.periodFraction);
      } else {
        // Pro-rated (actual for the period selected - quarter, YTD, or custom)
        perSeniorSavings = Math.round(taxpayerSavings / perSenior);
        perSeniorSpending = Math.round(seniorSpending / perSenior);
      }
      
      let html = '<div id="detailedResults" class="no-print" style="margin-top: 24px; max-width: 1080px; margin-left: auto; margin-right: auto;">';
      
      // Hero number - matches card styling exactly
      if (totalEconomicBenefit > 0) {
        html += `
          <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 18px; padding: 32px; text-align: center; color: white; box-shadow: 0 12px 40px rgba(10,12,16,.10); margin-bottom: 16px;">
            <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.85; margin-bottom: 8px;">Total Economic Benefit</div>
            <div style="font-size: 48px; font-weight: 900; letter-spacing: -0.02em; margin-bottom: 6px;">${fmt(totalEconomicBenefit)}</div>
            <div style="font-size: 15px; opacity: 0.9;">Lifetime Impact (${avgStay} years) â€¢ ${perSenior} Seniors</div>
          </div>
        `;
      }
      
      // Three cards - seamless like existing card-row
      html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0; margin-top: 16px; background: white; border: 1px solid #e6e9ee; border-radius: 18px; overflow: hidden; box-shadow: 0 12px 40px rgba(10,12,16,.10); margin-bottom: 16px; position: relative;">';
      
      // Card 1: Cost Avoidance
      html += `
        <div style="padding: 32px; position: relative; background: white;">
          <div style="font-size: 18px; font-weight: 700; color: #0b1220; margin-bottom: 18px;">ðŸ’° Cost Avoidance</div>
          <div style="font-size: 12px; color: #6b7280; margin-bottom: 6px;">Base Calculation:</div>
          <div style="font-size: 13px; color: #374151; margin-bottom: 12px;">
            ${perSenior} seniors Ã— ${fmtLong(perSeniorSavings)}/senior = ${fmt(taxpayerSavings)}
          </div>
          <div style="font-size: 12px; color: #6b7280; margin-bottom: 6px;">With Multiplier (${state.multiplier}Ã—):</div>
          <div style="font-size: 13px; color: #374151; margin-bottom: 16px;">
            ${fmt(taxpayerSavings)} Ã— ${state.multiplier} = ${fmt(multipliedSavings)}
          </div>
          <div style="border-top: 1px solid #e6e9ee; padding-top: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 12px;">
            <div>
              <div style="color: #6b7280; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em; font-size: 11px;">Annual</div>
              <div style="font-size: 20px; font-weight: 900; color: #0b1220;">${fmt(multipliedSavings)}</div>
            </div>
            <div style="text-align: right;">
              <div style="color: #6b7280; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em; font-size: 11px;">Total Impact (${avgStay}y)</div>
              <div style="font-size: 20px; font-weight: 900; color: #0b1220;">${fmt(multipliedSavings * avgStay)}</div>
            </div>
          </div>
        </div>
      `;
      
      // Card 2: Senior Spending (with left divider)
      html += `
        <div style="padding: 32px; position: relative; background: white;">
          <div style="position: absolute; left: 0; top: 24px; bottom: 24px; width: 1px; background: #e6e9ee;"></div>
          <div style="font-size: 18px; font-weight: 700; color: #0b1220; margin-bottom: 18px;">ðŸ›ï¸ Local Spending</div>
          <div style="font-size: 12px; color: #6b7280; margin-bottom: 6px;">Calculation:</div>
          <div style="font-size: 13px; color: #374151; margin-bottom: 12px;">
            ${perSenior} seniors Ã— ${fmtLong(perSeniorSpending)}/senior = ${fmt(seniorSpending)}
          </div>
          <div style="font-size: 12px; color: #6b7280; margin-bottom: 6px;">Impact:</div>
          <div style="font-size: 12px; color: #374151; line-height: 1.6; margin-bottom: 16px;">
            â€¢ Local economic activity<br>
            â€¢ Supports businesses<br>
            â€¢ Community benefit
          </div>
          <div style="border-top: 1px solid #e6e9ee; padding-top: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 12px;">
            <div>
              <div style="color: #6b7280; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em; font-size: 11px;">Annual</div>
              <div style="font-size: 20px; font-weight: 900; color: #0b1220;">${fmt(seniorSpending)}</div>
            </div>
            <div style="text-align: right;">
              <div style="color: #6b7280; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em; font-size: 11px;">Total Impact (${avgStay}y)</div>
              <div style="font-size: 20px; font-weight: 900; color: #0b1220;">${fmt(seniorSpending * avgStay)}</div>
            </div>
          </div>
        </div>
      `;
      
      // Card 3: Tax Revenue (with left divider)
      html += `
        <div style="padding: 32px; position: relative; background: white;">
          <div style="position: absolute; left: 0; top: 24px; bottom: 24px; width: 1px; background: #e6e9ee;"></div>
          <div style="font-size: 18px; font-weight: 700; color: #0b1220; margin-bottom: 18px;">ðŸ’µ Tax Revenue</div>
          <div style="font-size: 12px; color: #6b7280; margin-bottom: 6px;">Generated Taxes:</div>
          <div style="font-size: 12px; color: #374151; line-height: 1.7; margin-bottom: 12px;">
            Federal (22%): ${fmt(fedTax)}<br>
            State (7%): ${fmt(stateTax)}<br>
            Local (1%): ${fmt(localTax)}
          </div>
          <div style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 16px;">
            Total: ${fmt(totalTaxes)} (30%)
          </div>
          <div style="border-top: 1px solid #e6e9ee; padding-top: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 12px;">
            <div>
              <div style="color: #6b7280; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em; font-size: 11px;">Annual</div>
              <div style="font-size: 20px; font-weight: 900; color: #0b1220;">${fmt(totalTaxes)}</div>
            </div>
            <div style="text-align: right;">
              <div style="color: #6b7280; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em; font-size: 11px;">Total Impact (${avgStay}y)</div>
              <div style="font-size: 20px; font-weight: 900; color: #0b1220;">${fmt(totalTaxes * avgStay)}</div>
            </div>
          </div>
        </div>
      `;
      
      html += '</div>'; // End three cards
      
      // Summary table - matches existing card styling
      html += `
        <div style="background: white; border: 1px solid #e6e9ee; border-radius: 18px; padding: 32px; box-shadow: 0 12px 40px rgba(10,12,16,.10); margin-top: 16px;">
          <div style="font-size: 18px; font-weight: 700; color: #0b1220; margin-bottom: 20px;">ðŸ“Š Total Breakdown</div>
          
          <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
            <thead>
              <tr style="border-bottom: 2px solid #e6e9ee;">
                <th style="text-align: left; padding: 10px 0; font-size: 12px; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Component</th>
                <th style="text-align: right; padding: 10px 0; font-size: 12px; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Annual</th>
                <th style="text-align: right; padding: 10px 0; font-size: 12px; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Total Impact (${avgStay}y)</th>
              </tr>
            </thead>
            <tbody>
              <tr style="border-bottom: 1px solid #f3f4f6;">
                <td style="padding: 10px 0; color: #374151;">Cost Avoidance <span style="font-size: 11px; color: #9ca3af;">(${state.multiplier}Ã—)</span></td>
                <td style="text-align: right; padding: 10px 0; font-weight: 600; color: #374151;">${fmt(multipliedSavings)}</td>
                <td style="text-align: right; padding: 10px 0; font-weight: 600; color: #374151;">${fmt(multipliedSavings * avgStay)}</td>
              </tr>
              <tr style="border-bottom: 1px solid #f3f4f6;">
                <td style="padding: 10px 0; color: #374151;">Senior Local Spending</td>
                <td style="text-align: right; padding: 10px 0; font-weight: 600; color: #374151;">${fmt(seniorSpending)}</td>
                <td style="text-align: right; padding: 10px 0; font-weight: 600; color: #374151;">${fmt(seniorSpending * avgStay)}</td>
              </tr>
              <tr style="border-bottom: 2px solid #e6e9ee;">
                <td style="padding: 10px 0; color: #374151;">Tax Revenue <span style="font-size: 11px; color: #9ca3af;">(30%)</span></td>
                <td style="text-align: right; padding: 10px 0; font-weight: 600; color: #374151;">${fmt(totalTaxes)}</td>
                <td style="text-align: right; padding: 10px 0; font-weight: 600; color: #374151;">${fmt(totalTaxes * avgStay)}</td>
              </tr>
              <tr style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(10, 132, 255, 0.05));">
                <td style="padding: 14px 0; font-weight: 800; color: #059669; font-size: 15px;">TOTAL</td>
                <td style="text-align: right; padding: 14px 0; font-weight: 900; color: #059669; font-size: 18px;">${fmt(economicOutput)}</td>
                <td style="text-align: right; padding: 14px 0; font-weight: 900; color: #059669; font-size: 18px;">${fmt(totalEconomicBenefit)}</td>
              </tr>
            </tbody>
          </table>
          
          <div style="margin-top: 16px; padding: 12px; background: #f9fafb; border-radius: 12px; font-size: 12px; color: #6b7280; text-align: center;">
            <strong>Per-Senior:</strong> ${fmt(economicOutput / perSenior)} annual â€¢ ${fmt(totalEconomicBenefit / perSenior)} total impact (${avgStay}y avg)
          </div>
        </div>
      `;
      
      html += '</div>'; // End detailedResults
      
      // Insert or update
      const execSummary = document.querySelector('.pw-card');
      let display = document.getElementById('equationResultsDisplay');
      
      if (!display && execSummary) {
        display = document.createElement('div');
        display.id = 'equationResultsDisplay';
        display.className = 'no-print';
        execSummary.after(display);
      }
      
      if (display) {
        display.innerHTML = html;
      }
    }
    
    // ============================================
    // SCENARIO SELECTION
    // ============================================

    // Scenario selection
    document.querySelectorAll('.scenario-card').forEach(card => {
      card.addEventListener('click', () => {
        document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('active'));
        card.classList.add('active');
        
        state.scenario = card.dataset.scenario;
        state.multiplier = parseFloat(card.dataset.multiplier);
        
        // Update the TAXPAYER_MULTIPLIER parameter for equations
        if (configData.params) {
          configData.params['TAXPAYER_MULTIPLIER'] = state.multiplier;
          console.log(`ðŸ”„ Updated TAXPAYER_MULTIPLIER to ${state.multiplier}`);
        }
        
        document.getElementById('scenarioDesc').innerHTML = `
          <strong>${scenarios[state.scenario].label}:</strong> ${scenarios[state.scenario].desc}
        `;
        
        // Re-evaluate equations if we have tallies data
        if (state.currentTallies && state.currentTallies.length > 0) {
          console.log(`ðŸ”„ Re-calculating equations with ${state.multiplier}Ã— multiplier...`);
          
          const equationResults = evaluateAllEquations(state.currentTallies, state.periodFraction);
          state.equationResults = equationResults;
          
          console.log('âœ… Equations re-evaluated with new multiplier');
        } else {
          console.warn('âš ï¸ No tallies data available. Click "Generate Report" first.');
        }
        
        updateUI();
      });
    });
    
    // ============================================
    // INPUT HANDLERS
    // ============================================

    // Input handlers (allow manual override after generation)
    document.getElementById('servicesProvided').addEventListener('input', (e) => {
      state.services = parseInt(e.target.value) || 0;
      updateUI();
    });
    
    document.getElementById('avgCost').addEventListener('input', (e) => {
      state.avgCost = parseInt(e.target.value) || 0;
      updateUI();
    });
    
    document.getElementById('yearsRange').addEventListener('input', (e) => {
      state.years = parseInt(e.target.value);
      updateUI();
    });
    
    document.getElementById('orgName').addEventListener('input', updateUI);
    
    // ============================================
    // PDF EXPORT
    // ============================================

    // Export PDF with print dialog
    document.getElementById('exportBtn').addEventListener('click', () => {
      // Add a class to body to optimize for print
      document.body.classList.add('printing');
      
      // Small delay to ensure styles are applied
      setTimeout(() => {
        window.print();
        
        // Remove class after print dialog closes
        setTimeout(() => {
          document.body.classList.remove('printing');
        }, 100);
      }, 100);
    });
    
    // ============================================
    // CHARTS
    // ============================================

    let cumulativeChart, comparisonChart;
    
    function updateCharts() {
      const { base, adjusted } = calculate();
      
      // Cumulative data
      const yearlyData = Array.from({ length: state.years }, (_, i) => ({
        year: i + 1,
        cumulative: adjusted * (i + 1)
      }));
      
      // Update cumulative chart
      if (cumulativeChart) {
        cumulativeChart.data.labels = yearlyData.map(d => `Year ${d.year}`);
        cumulativeChart.data.datasets[0].data = yearlyData.map(d => d.cumulative);
        cumulativeChart.update();
      } else {
        const ctx1 = document.getElementById('cumulativeChart').getContext('2d');
        cumulativeChart = new Chart(ctx1, {
          type: 'line',
          data: {
            labels: yearlyData.map(d => `Year ${d.year}`),
            datasets: [{
              label: 'Cumulative Impact',
              data: yearlyData.map(d => d.cumulative),
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: (context) => `$${(context.parsed.y / 1000000).toFixed(2)}M`
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: (value) => `$${(value / 1000000).toFixed(1)}M`
                }
              }
            }
          }
        });
      }
      
      // Comparison data
      const comparisonData = [
        { scenario: 'Conservative', value: base * 1.25 },
        { scenario: 'Moderate', value: base * 1.5 },
        { scenario: 'Comprehensive', value: base * 2.0 }
      ];
      
      // Update comparison chart
      if (comparisonChart) {
        comparisonChart.data.datasets[0].data = comparisonData.map(d => d.value);
        comparisonChart.update();
      } else {
        const ctx2 = document.getElementById('comparisonChart').getContext('2d');
        comparisonChart = new Chart(ctx2, {
          type: 'bar',
          data: {
            labels: comparisonData.map(d => d.scenario),
            datasets: [{
              label: 'Annual Impact',
              data: comparisonData.map(d => d.value),
              backgroundColor: [
                'rgba(59, 130, 246, 0.8)',
                'rgba(16, 185, 129, 0.8)',
                'rgba(249, 115, 22, 0.8)'
              ],
              borderColor: [
                'rgba(59, 130, 246, 1)',
                'rgba(16, 185, 129, 1)',
                'rgba(249, 115, 22, 1)'
              ],
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: (context) => `$${(context.parsed.y / 1000000).toFixed(2)}M`
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: (value) => `$${(value / 1000000).toFixed(1)}M`
                }
              }
            }
          }
        });
      }
    }
    
    // Initialize
    updateUI();
  </script>
</body>
</html>