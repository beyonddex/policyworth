<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard â€” PolicyWorth</title>
  <link rel="stylesheet" href="/css/styles.css" />

  <!-- Auth bootstrap -->
  <script type="module" src="/js/auth.js"></script>
  <script type="module" src="/js/nav-auth.js"></script>
  <script type="module">
    /* Auth guard: require login */
    import { auth } from '/js/auth.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        const next = encodeURIComponent(window.location.pathname);
        window.location.href = `/login.html?next=${next}`;
      }
    });
  </script>
  
  <style>
    /* Dashboard-specific styles */
    :root {
      --pw-ink: #0b1220;
      --pw-text: #2a3342;
      --pw-muted: #6b7280;
      --pw-line: #e6e9ee;
      --pw-accent: #0a84ff;
      --pw-green: #12b981;
      --pw-radius-lg: 18px;
      --pw-shadow-1: 0 2px 6px rgba(10,12,16,.05), 0 10px 30px rgba(10,12,16,.06);
      --pw-shadow-2: 0 12px 40px rgba(10,12,16,.10);
      --pw-glass: rgba(255,255,255,.72);
    }
    
    /* Apple-style gradient background */
    body.pw-dashboard {
      background:
        radial-gradient(800px 380px at 15% -10%, rgba(10,132,255,.08), transparent 60%),
        radial-gradient(700px 380px at 85% -20%, rgba(18,185,129,.10), transparent 60%),
        #fbfcfe;
    }
    
    .pw-container {
      max-width: 1080px;
      margin: 0 auto;
      padding: 48px 28px 80px;
    }
    
    /* Hero section */
    .pw-hero {
      margin: 6px 0 24px;
    }
    .pw-title {
      font-size: clamp(30px, 4.4vw, 40px);
      font-weight: 900;
      letter-spacing: -0.02em;
      color: var(--pw-ink);
      margin: 0;
    }
    .pw-subtitle {
      color: var(--pw-muted);
      font-size: 15px;
      margin-top: 6px;
    }
    
    /* Buttons */
    .pw-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      padding: 12px 18px;
      box-shadow: var(--pw-shadow-1);
      transition: transform .06s ease, box-shadow .18s ease, background .18s ease;
      border: none;
      font-weight: 700;
      cursor: pointer;
      font-size: 15px;
    }
    .pw-btn.primary {
      background: linear-gradient(180deg, #0b86ff, #0776e8);
      color: #fff;
      border: 1px solid rgba(0,0,0,.04);
    }
    .pw-btn.primary:hover {
      transform: translateY(-1px);
      box-shadow: var(--pw-shadow-2);
      filter: brightness(1.02);
    }
    .pw-btn.ghost {
      background: #fff;
      border: 1px solid var(--pw-line);
      color: var(--pw-ink);
    }
    .pw-btn.ghost:hover {
      background: #f3f6fb;
      transform: translateY(-1px);
      box-shadow: var(--pw-shadow-2);
    }
    
    /* Filter/Report Builder */
    .pw-filter {
      background: rgba(255,255,255,.88);
      backdrop-filter: saturate(1.1) blur(10px);
      border: 1px solid var(--pw-line);
      border-radius: var(--pw-radius-lg);
      box-shadow: var(--pw-shadow-2);
      padding: 22px;
      margin-bottom: 24px;
    }
    
    .eyebrow {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--pw-muted);
      margin-bottom: 12px;
      font-weight: 600;
    }
    
    .pw-controls {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(12, minmax(0,1fr));
    }
    
    .pw-field {
      grid-column: span 3;
      min-width: 0;
    }
    .pw-field.wide {
      grid-column: span 6;
    }
    .pw-field.full {
      grid-column: 1 / -1;
    }
    
    .pw-label {
      display: block;
      margin-bottom: 6px;
      color: var(--pw-muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .06em;
      font-weight: 600;
    }
    
    .pw-input, .pw-select {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--pw-line);
      border-radius: 14px;
      background: #fff;
      font-size: 15px;
      box-shadow: var(--pw-shadow-1);
      outline: none;
    }
    .pw-input:focus, .pw-select:focus {
      border-color: #b9d8ff;
      box-shadow: 0 0 0 4px rgba(10,132,255,.18);
    }
    
    /* Service chips */
    .svc-chips {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(4, minmax(0,1fr));
    }
    .svc-chip {
      position: relative;
      display: block;
    }
    .svc-chip input {
      position: absolute;
      inset: 0;
      opacity: 0;
      pointer-events: none;
    }
    .svc-chip span {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 42px;
      padding: 0 14px;
      border: 1px solid var(--pw-line);
      border-radius: 14px;
      background: #fff;
      font-weight: 600;
      color: var(--pw-text);
      box-shadow: var(--pw-shadow-1);
      transition: .18s;
    }
    .svc-chip span:hover {
      border-color: #cfe6dc;
      box-shadow: 0 0 0 4px rgba(18,185,129,.12) inset;
    }
    .svc-chip input:checked + span {
      background: #f2fbf7;
      border-color: #b8e6d5;
      color: #0e7e57;
    }
    
    .pw-actions {
      grid-column: 1 / -1;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 10px;
    }
    
    /* Cards */
    .pw-card {
      background: #fff;
      border: 1px solid var(--pw-line);
      border-radius: var(--pw-radius-lg);
      box-shadow: var(--pw-shadow-2);
      padding: 32px;
      margin-top: 16px;
    }
    
    .pw-card .title {
      font-size: clamp(18px, 2.2vw, 22px);
      font-weight: 800;
      letter-spacing: -0.01em;
      color: var(--pw-ink);
    }
    
    /* Seamless card grid - puzzle piece effect */
    .card-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0;
      margin-top: 16px;
      background: white;
      border: 1px solid var(--pw-line);
      border-radius: var(--pw-radius-lg);
      overflow: hidden;
      box-shadow: var(--pw-shadow-2);
    }
    
    .card-row .card-section {
      padding: 32px;
      position: relative;
    }
    
    .card-row .card-section + .card-section::before {
      content: '';
      position: absolute;
      left: 0;
      top: 24px;
      bottom: 24px;
      width: 1px;
      background: var(--pw-line);
    }
    
    /* Executive header - dark gradient */
    .exec-header {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border-radius: var(--pw-radius-lg);
      padding: 40px;
      margin-top: 24px;
      color: white;
      box-shadow: var(--pw-shadow-2);
    }
    
    .exec-header input {
      background: transparent;
      border: none;
      border-bottom: 1px solid rgba(255,255,255,.3);
      color: white;
      font-size: inherit;
      font-weight: inherit;
      outline: none;
      padding: 4px 0;
    }
    .exec-header input:focus {
      border-bottom-color: rgba(255,255,255,.8);
    }
    
    .org-title {
      font-size: clamp(24px, 3vw, 32px);
      font-weight: 700;
      margin-bottom: 12px;
    }
    
    .report-title {
      font-size: clamp(36px, 5vw, 48px);
      font-weight: 900;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }
    
    .report-subtitle {
      font-size: 18px;
      color: rgba(255,255,255,.8);
      margin-bottom: 32px;
    }
    
    .exec-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 48px;
      padding-top: 32px;
      border-top: 1px solid rgba(255,255,255,.2);
    }
    
    .exec-param {
      margin-bottom: 16px;
    }
    .exec-param label {
      display: block;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: rgba(255,255,255,.7);
      margin-bottom: 8px;
    }
    .exec-param input[type="number"],
    .exec-param input[type="range"] {
      width: 100%;
      padding: 12px;
      background: rgba(255,255,255,.1);
      border: 1px solid rgba(255,255,255,.2);
      border-radius: 12px;
      color: white;
      font-size: 16px;
      font-weight: 600;
    }
    .exec-param input:focus {
      background: rgba(255,255,255,.15);
      border-color: rgba(255,255,255,.5);
    }
    
    .range-value {
      text-align: center;
      margin-top: 8px;
      font-size: 18px;
      font-weight: 700;
    }
    
    .exec-metrics {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }
    
    .exec-metric {
      text-align: left;
    }
    .exec-metric-label {
      font-size: 12px;
      color: rgba(255,255,255,.7);
      margin-bottom: 4px;
    }
    .exec-metric-value {
      font-size: clamp(28px, 4vw, 36px);
      font-weight: 900;
    }
    
    /* Scenario cards */
    .scenarios {
      margin-top: 16px;
    }
    
    .scenario-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0;
      margin-bottom: 16px;
      background: white;
      border: 1px solid var(--pw-line);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--pw-shadow-2);
    }
    
    .scenario-card {
      padding: 28px;
      cursor: pointer;
      transition: all .2s ease;
      text-align: center;
      position: relative;
      border: none;
      background: white;
    }
    
    .scenario-card + .scenario-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 20px;
      bottom: 20px;
      width: 1px;
      background: var(--pw-line);
    }
    
    .scenario-card:hover {
      background: #f8fafb;
    }
    .scenario-card.active {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    .scenario-card.active::before {
      display: none;
    }
    
    .scenario-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .06em;
      font-weight: 600;
      margin-bottom: 8px;
      opacity: .7;
    }
    .scenario-card.active .scenario-label {
      opacity: .9;
    }
    
    .scenario-multiplier {
      font-size: 48px;
      font-weight: 900;
      letter-spacing: -0.02em;
    }
    
    .scenario-desc {
      background: #f8f9fa;
      border: 1px solid var(--pw-line);
      border-radius: 14px;
      padding: 20px;
      line-height: 1.6;
    }
    
    /* KPI Grid - seamless puzzle pieces */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0;
      margin-top: 16px;
      background: white;
      border: 1px solid var(--pw-line);
      border-radius: var(--pw-radius-lg);
      overflow: hidden;
      box-shadow: var(--pw-shadow-2);
    }
    
    .kpi-card {
      padding: 32px;
      position: relative;
      background: white;
      border: none;
    }
    
    .kpi-card + .kpi-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 24px;
      bottom: 24px;
      width: 1px;
      background: var(--pw-line);
    }
    
    .kpi-card.highlight {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    
    .kpi-card.highlight::before {
      display: none;
    }
    
    .kpi-card.highlight + .kpi-card::before {
      display: none;
    }
    
    .kpi-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: rgba(0,0,0,.05);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      font-size: 24px;
    }
    .kpi-card.highlight .kpi-icon {
      background: rgba(255,255,255,.2);
    }
    
    .kpi-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .06em;
      font-weight: 600;
      margin-bottom: 8px;
      opacity: .7;
    }
    
    .kpi-value {
      font-size: clamp(32px, 5vw, 42px);
      font-weight: 900;
      letter-spacing: -0.02em;
      margin-bottom: 4px;
    }
    
    .kpi-note {
      font-size: 13px;
      opacity: .7;
    }
    
    /* Charts - seamless side by side */
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0;
      margin-top: 16px;
      background: white;
      border: 1px solid var(--pw-line);
      border-radius: var(--pw-radius-lg);
      overflow: hidden;
      box-shadow: var(--pw-shadow-2);
    }
    
    .chart-card {
      padding: 32px;
      position: relative;
      border: none;
      background: white;
    }
    
    .chart-card + .chart-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 24px;
      bottom: 24px;
      width: 1px;
      background: var(--pw-line);
    }
    
    .chart-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--pw-ink);
      margin-bottom: 16px;
    }
    
    .chart-container {
      width: 100%;
      height: 320px;
      position: relative;
    }
    
    /* Print styles */
    @media print {
      /* Hide interactive elements */
      .site-header,
      .pw-filter, 
      .pw-actions, 
      .no-print {
        display: none !important;
      }
      
      /* Reset background and optimize for print */
      body.pw-dashboard {
        background: white !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      
      .pw-container {
        max-width: 100%;
        padding: 20px;
      }
      
      /* Hero section for print */
      .pw-hero {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e5e7eb;
      }
      
      /* Ensure cards don't break across pages */
      .pw-card,
      .exec-header,
      .card-row,
      .kpi-grid,
      .chart-grid {
        page-break-inside: avoid;
        break-inside: avoid;
        box-shadow: none;
        margin-bottom: 20px;
      }
      
      /* Keep gradient backgrounds for exec header */
      .exec-header {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        page-break-after: avoid;
      }
      
      /* Executive summary stays with header */
      .exec-header + .pw-card {
        page-break-before: avoid;
      }
      
      /* Keep scenario and KPI card colors */
      .scenario-card.active,
      .kpi-card.highlight {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      
      /* Optimize chart sizes for print */
      .chart-container {
        height: 280px !important;
      }
      
      .chart-grid {
        page-break-before: auto;
      }
      
      /* Add page breaks before major sections if needed */
      .scenarios {
        page-break-before: auto;
      }
      
      .kpi-grid {
        page-break-before: auto;
      }
      
      /* Ensure text is readable */
      body {
        font-size: 11pt;
        line-height: 1.5;
        color: #000;
      }
      
      .pw-title {
        font-size: 28pt;
        color: #000;
      }
      
      .pw-subtitle {
        font-size: 13pt;
      }
      
      .report-title {
        font-size: 32pt;
      }
      
      .eyebrow {
        font-size: 9pt;
      }
      
      /* Make sure borders print */
      .pw-card,
      .card-row,
      .kpi-grid,
      .chart-grid {
        border: 1px solid #d1d5db !important;
      }
      
      /* Ensure all text prints in black for readability */
      h1, h2, h3, h4, h5, h6, p, div, span {
        color-adjust: exact;
        -webkit-print-color-adjust: exact;
      }
      
      /* Page settings */
      @page {
        size: letter;
        margin: 0.75in 0.5in;
      }
      
      /* First page (cover) */
      @page :first {
        margin-top: 0.5in;
      }
    }
    
    /* Responsive */
    @media (max-width: 860px) {
      .pw-field {
        grid-column: 1 / -1;
      }
      .svc-chips {
        grid-template-columns: repeat(2, 1fr);
      }
      .exec-grid {
        grid-template-columns: 1fr;
      }
      .exec-metrics {
        grid-template-columns: 1fr;
      }
      .scenario-grid {
        grid-template-columns: 1fr;
      }
      .scenario-card + .scenario-card::before {
        display: none;
      }
      .scenario-card {
        border-top: 1px solid var(--pw-line);
      }
      .scenario-card:first-child {
        border-top: none;
      }
      .kpi-grid {
        grid-template-columns: 1fr;
      }
      .kpi-card + .kpi-card::before {
        display: none;
      }
      .kpi-card {
        border-top: 1px solid var(--pw-line);
      }
      .kpi-card:first-child {
        border-top: none;
      }
      .chart-grid {
        grid-template-columns: 1fr;
      }
      .chart-card + .chart-card::before {
        display: none;
      }
      .chart-card {
        border-top: 1px solid var(--pw-line);
      }
      .chart-card:first-child {
        border-top: none;
      }
      .card-row {
        grid-template-columns: 1fr;
      }
      .card-row .card-section + .card-section::before {
        display: none;
      }
      .card-row .card-section {
        border-top: 1px solid var(--pw-line);
      }
      .card-row .card-section:first-child {
        border-top: none;
      }
    }
  </style>
</head>
<body class="pw-dashboard">
  <noscript>
    <div class="container" style="padding:16px">
      <div class="card">JavaScript is required for the Dashboard.</div>
    </div>
  </noscript>

  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="/"><span class="brand-mark">PW</span><span class="brand-name">PolicyWorth</span></a>
      <nav class="nav"><ul>
        <li><a class="link" href="/index.html">Home</a></li>
        <!-- Current page -->
        <li><a class="link" href="/dashboard.html" aria-current="page">Dashboard</a></li>
        <li><a class="link" data-gated data-href="/survey.html" title="Login to access">Survey</a></li>
        <li><a class="link" data-gated data-href="/data-entry.html" title="Login to access">Data Entry</a></li>
        <!-- Admin-only + gated -->
        <li><a class="link" data-gated data-admin-only="true" data-href="/settings.html" title="Admins only">Settings</a></li>
      </ul></nav>
      <div class="auth"></div>
    </div>
  </header>

  <main class="pw-container">
    <!-- Hero -->
    <section class="pw-hero">
      <h1 class="pw-title">Impact Dashboard</h1>
      <p class="pw-subtitle">Economic modeling and projections for stakeholders</p>
    </section>
    
    <!-- Report Builder (No Print) -->
    <section class="pw-filter no-print">
      <div class="eyebrow">Report Builder</div>
      <div class="pw-controls">
        <label class="pw-field">
          <span class="pw-label">Period type</span>
          <select id="periodType" class="pw-select">
            <option value="quarter">Quarter</option>
            <option value="year">Annual</option>
            <option value="ytd">YTD</option>
            <option value="custom">Custom</option>
          </select>
        </label>
        
        <label class="pw-field" id="quarterField">
          <span class="pw-label">Quarter</span>
          <select id="quarter" class="pw-select">
            <option value="1">Q1</option>
            <option value="2">Q2</option>
            <option value="3">Q3</option>
            <option value="4" selected>Q4</option>
          </select>
        </label>
        
        <label class="pw-field" id="yearField">
          <span class="pw-label">Year</span>
          <select id="year" class="pw-select">
            <option value="2023">2023</option>
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
          </select>
        </label>
        
        <!-- Custom date range (hidden by default) -->
        <label class="pw-field" id="startDateField" style="display: none;">
          <span class="pw-label">Start Date</span>
          <input type="date" id="startDate" class="pw-input">
        </label>
        
        <label class="pw-field" id="endDateField" style="display: none;">
          <span class="pw-label">End Date</span>
          <input type="date" id="endDate" class="pw-input">
        </label>
        
        <div class="pw-field full">
          <span class="pw-label">Services (select all that apply)</span>
          <div id="services" class="svc-chips">
            <label class="svc-chip"><input type="checkbox" value="case_mgmt"><span>Case Management</span></label>
            <label class="svc-chip"><input type="checkbox" value="hdm"><span>Home-Delivered Meals</span></label>
            <label class="svc-chip"><input type="checkbox" value="caregiver_respite"><span>Caregiver / Respite</span></label>
            <label class="svc-chip"><input type="checkbox" value="crisis_intervention"><span>Crisis Intervention</span></label>
          </div>
        </div>
        
        <div class="pw-actions">
          <button id="generateBtn" class="pw-btn primary">Generate Report</button>
          <button id="exportBtn" class="pw-btn ghost">Export PDF</button>
        </div>
      </div>
    </section>
    
    <!-- Executive Header -->
    <section class="exec-header">
      <div class="org-title">
        <input type="text" id="orgName" value="Community Care Alliance" style="width: 100%; max-width: 400px;">
      </div>
      <div class="report-title">Economic Impact Report</div>
      <div class="report-subtitle">Community-Based Care Services</div>
      
      <div class="exec-grid">
        <!-- Left: Parameters -->
        <div>
          <h3 style="margin: 0 0 20px; font-size: 18px; opacity: .9;">Model Parameters</h3>
          <div class="exec-param">
            <label>Annual Services Provided</label>
            <input type="number" id="servicesProvided" value="250">
          </div>
          <div class="exec-param">
            <label>Avg Institutional Cost/Year</label>
            <input type="number" id="avgCost" value="15000">
          </div>
          <div class="exec-param">
            <label>Projection Period</label>
            <input type="range" id="yearsRange" min="1" max="10" value="5">
            <div class="range-value"><span id="yearsValue">5</span> years</div>
          </div>
        </div>
        
        <!-- Right: Metrics -->
        <div>
          <h3 style="margin: 0 0 20px; font-size: 18px; opacity: .9;">Key Metrics</h3>
          <div class="exec-metrics">
            <div class="exec-metric">
              <div class="exec-metric-label">Clients Served</div>
              <div class="exec-metric-value" id="clientsServed">250</div>
            </div>
            <div class="exec-metric">
              <div class="exec-metric-label">Total Impact</div>
              <div class="exec-metric-value" id="totalImpact">$15.75M</div>
            </div>
            <div class="exec-metric">
              <div class="exec-metric-label">ROI</div>
              <div class="exec-metric-value" id="roi">320%</div>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Executive Summary -->
    <section class="pw-card">
      <div class="eyebrow">Executive Summary</div>
      <div class="title" style="margin-bottom: 20px;">Impact Overview</div>
      <p style="line-height: 1.7; color: var(--pw-text); font-size: 15px;" id="execSummary">
        In fiscal year 2024, <strong>Community Care Alliance</strong> provided community-based care services to <strong>250 clients</strong>, preventing institutional placement and enabling individuals to age in place with dignity. Through our moderate economic model, these services generated an estimated <strong style="color: #10b981;">$15.75 million</strong> in total economic impact to taxpayers and the community.
      </p>
    </section>
    
    <!-- Care Scenarios -->
    <div class="card-row scenarios">
      <div class="card-section" style="grid-column: 1 / -1;">
        <div class="eyebrow">Economic Impact Methodology</div>
        <div class="title" style="margin-bottom: 20px;">Care Scenario Multipliers</div>
        
        <div class="scenario-grid">
          <div class="scenario-card" data-scenario="conservative" data-multiplier="2.5">
            <div class="scenario-label">Conservative</div>
            <div class="scenario-multiplier">2.5Ã—</div>
          </div>
          <div class="scenario-card active" data-scenario="moderate" data-multiplier="4.2">
            <div class="scenario-label">Moderate</div>
            <div class="scenario-multiplier">4.2Ã—</div>
          </div>
          <div class="scenario-card" data-scenario="comprehensive" data-multiplier="6.8">
            <div class="scenario-label">Comprehensive</div>
            <div class="scenario-multiplier">6.8Ã—</div>
          </div>
        </div>
        
        <div class="scenario-desc" id="scenarioDesc">
          <strong>Moderate Scenario Impact:</strong> Comprehensive home care with case management prevents institutional placement, reduces hospitalizations by 65%, enables medication management, and maintains family caregivers in the workforceâ€”creating secondary economic benefits averaging $45,000 per household annually in retained income and continued tax contributions.
        </div>
      </div>
    </div>
    
    <!-- KPIs -->
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-icon">ðŸ’°</div>
        <div class="kpi-label">Direct Cost Avoidance</div>
        <div class="kpi-value" id="baseSavings">$3.75M</div>
        <div class="kpi-note">Annual institutional care costs prevented</div>
      </div>
      <div class="kpi-card highlight">
        <div class="kpi-icon">ðŸ“ˆ</div>
        <div class="kpi-label">Total Economic Impact</div>
        <div class="kpi-value" id="adjustedSavings">$15.75M</div>
        <div class="kpi-note">Including multiplier effects (4.2Ã—)</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">ðŸ“…</div>
        <div class="kpi-label"><span id="projectionYears">5</span>-Year Projection</div>
        <div class="kpi-value" id="multiYear">$78.75M</div>
        <div class="kpi-note">Cumulative taxpayer savings projected</div>
      </div>
    </div>
    
    <!-- Charts -->
    <div class="chart-grid">
      <div class="chart-card">
        <div class="chart-title">Cumulative Economic Impact</div>
        <div class="chart-container">
          <canvas id="cumulativeChart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <div class="chart-title">Scenario Comparison</div>
        <div class="chart-container">
          <canvas id="comparisonChart"></canvas>
        </div>
      </div>
    </div>
  </main>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script type="module">
    import { auth, db } from '/js/auth.js';
    import { collection, query, where, getDocs, orderBy } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

    // Service labels mapping
    const SERVICE_LABELS = {
      case_mgmt: 'Case Management',
      hdm: 'Home-Delivered Meals',
      caregiver_respite: 'Caregiver/Respite',
      crisis_intervention: 'Crisis Intervention'
    };

    // State
    let state = {
      services: 250,
      avgCost: 15000,
      years: 5,
      multiplier: 4.2,
      scenario: 'moderate',
      currentUser: null
    };
    
    const scenarios = {
      conservative: {
        multiplier: 2.5,
        label: 'Conservative Estimate',
        desc: 'Based on direct cost avoidance through prevention of institutional care placement and reduction in emergency medical services utilization. On average, clients remain at home with basic support services, avoiding $65,000+ annual institutional care costs.'
      },
      moderate: {
        multiplier: 4.2,
        label: 'Moderate Estimate',
        desc: 'Comprehensive home care with case management prevents institutional placement, reduces hospitalizations by 65%, enables medication management, and maintains family caregivers in the workforceâ€”creating secondary economic benefits averaging $45,000 per household annually in retained income and continued tax contributions.'
      },
      comprehensive: {
        multiplier: 6.8,
        label: 'Comprehensive Estimate',
        desc: 'Full-spectrum support including respite care, health monitoring, and social services. Prevents nursing home placement, reduces hospital costs by 80%, keeps caregivers employed (avg. $45K/year income retained), and creates community multiplier effects through local spending.'
      }
    };

    // Listen for auth state
    onAuthStateChanged(auth, (user) => {
      state.currentUser = user;
    });

    // Period type handler - show/hide fields
    function updatePeriodFields() {
      const periodType = document.getElementById('periodType').value;
      const quarterField = document.getElementById('quarterField');
      const yearField = document.getElementById('yearField');
      const startDateField = document.getElementById('startDateField');
      const endDateField = document.getElementById('endDateField');

      // Reset all to hidden
      quarterField.style.display = 'none';
      yearField.style.display = 'block';
      startDateField.style.display = 'none';
      endDateField.style.display = 'none';

      switch(periodType) {
        case 'quarter':
          quarterField.style.display = 'block';
          yearField.style.display = 'block';
          break;
        case 'year':
          // Only year field visible (already set above)
          break;
        case 'ytd':
          yearField.style.display = 'block';
          break;
        case 'custom':
          startDateField.style.display = 'block';
          endDateField.style.display = 'block';
          yearField.style.display = 'none';
          break;
      }
    }

    // Initialize period field visibility
    document.getElementById('periodType').addEventListener('change', updatePeriodFields);
    updatePeriodFields();

    // Get date range based on period type
    function getDateRange() {
      const periodType = document.getElementById('periodType').value;
      const year = parseInt(document.getElementById('year').value);
      const quarter = parseInt(document.getElementById('quarter').value);
      
      let startDate, endDate;

      switch(periodType) {
        case 'quarter':
          const qtrStart = (quarter - 1) * 3; // 0, 3, 6, 9
          startDate = new Date(year, qtrStart, 1);
          endDate = new Date(year, qtrStart + 3, 0); // Last day of quarter
          break;
        
        case 'year':
          startDate = new Date(year, 0, 1);
          endDate = new Date(year, 11, 31);
          break;
        
        case 'ytd':
          startDate = new Date(year, 0, 1);
          endDate = new Date(); // Today
          break;
        
        case 'custom':
          const startInput = document.getElementById('startDate').value;
          const endInput = document.getElementById('endDate').value;
          if (!startInput || !endInput) {
            alert('Please select both start and end dates for custom range');
            return null;
          }
          startDate = new Date(startInput);
          endDate = new Date(endInput);
          break;
      }

      return { startDate, endDate };
    }

    // Get selected services
    function getSelectedServices() {
      const checkboxes = document.querySelectorAll('#services input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }

    // Fetch tallies from Firestore
    async function fetchTallies(startDate, endDate, services) {
      if (!state.currentUser) {
        console.error('No user logged in');
        return [];
      }

      try {
        const talliesRef = collection(db, 'users', state.currentUser.uid, 'tallies');
        
        // Build query
        let q = query(
          talliesRef,
          where('date', '>=', startDate.toISOString().split('T')[0]),
          where('date', '<=', endDate.toISOString().split('T')[0]),
          orderBy('date', 'desc')
        );

        const snapshot = await getDocs(q);
        const tallies = [];
        
        snapshot.forEach(doc => {
          const data = doc.data();
          // Filter by selected services if any
          if (services.length === 0 || services.includes(data.service)) {
            tallies.push({
              id: doc.id,
              ...data
            });
          }
        });

        return tallies;
      } catch (error) {
        console.error('Error fetching tallies:', error);
        return [];
      }
    }

    // Aggregate data from tallies
    function aggregateTallies(tallies) {
      let totalYes = 0;
      let totalNo = 0;
      let totalCost = 0;
      let serviceCount = 0;
      const serviceCosts = {};
      const serviceCounts = {};

      tallies.forEach(tally => {
        totalYes += (tally.yes || 0);
        totalNo += (tally.no || 0);
        
        const cost = tally.avgCostYear || 0;
        if (cost > 0) {
          totalCost += cost;
          serviceCount++;
          
          // Track by service type for averaging
          if (!serviceCosts[tally.service]) {
            serviceCosts[tally.service] = 0;
            serviceCounts[tally.service] = 0;
          }
          serviceCosts[tally.service] += cost;
          serviceCounts[tally.service]++;
        }
      });

      // Calculate average cost
      const avgCost = serviceCount > 0 ? Math.round(totalCost / serviceCount) : 15000;
      
      return {
        servicesProvided: totalYes,
        avgCost: avgCost,
        totalYes,
        totalNo,
        totalTallies: tallies.length,
        serviceCosts,
        serviceCounts
      };
    }

    // Generate report from Firestore data
    async function generateReport() {
      const dateRange = getDateRange();
      if (!dateRange) return;

      const { startDate, endDate } = dateRange;
      const selectedServices = getSelectedServices();

      // Show loading state
      const btn = document.getElementById('generateBtn');
      const originalText = btn.textContent;
      btn.textContent = 'Loading...';
      btn.disabled = true;

      try {
        // Fetch tallies
        const tallies = await fetchTallies(startDate, endDate, selectedServices);
        
        if (tallies.length === 0) {
          alert('No data found for the selected period and services. Please check your data entry or adjust the filters.');
          return;
        }

        // Aggregate data
        const aggregated = aggregateTallies(tallies);

        // Update state with aggregated data
        state.services = aggregated.servicesProvided;
        state.avgCost = aggregated.avgCost;

        // Update the model parameter inputs to show what was calculated
        document.getElementById('servicesProvided').value = state.services;
        document.getElementById('avgCost').value = state.avgCost;

        // Update UI
        updateUI();

        console.log('Report generated:', {
          period: `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`,
          services: selectedServices.length > 0 ? selectedServices.map(s => SERVICE_LABELS[s]).join(', ') : 'All services',
          tallies: tallies.length,
          aggregated
        });

      } catch (error) {
        console.error('Error generating report:', error);
        alert('Error generating report. Please try again.');
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    // Generate button handler
    document.getElementById('generateBtn').addEventListener('click', generateReport);
    
    // Calculate metrics
    function calculate() {
      const base = state.services * state.avgCost;
      const adjusted = base * state.multiplier;
      const multi = adjusted * state.years;
      const roi = ((state.multiplier - 1) * 100).toFixed(0);
      
      return { base, adjusted, multi, roi };
    }
    
    // Update UI
    function updateUI() {
      const { base, adjusted, multi, roi } = calculate();
      
      document.getElementById('clientsServed').textContent = state.services.toLocaleString();
      document.getElementById('totalImpact').textContent = `$${(adjusted / 1000000).toFixed(2)}M`;
      document.getElementById('roi').textContent = `${roi}%`;
      document.getElementById('baseSavings').textContent = `$${(base / 1000000).toFixed(2)}M`;
      document.getElementById('adjustedSavings').textContent = `$${(adjusted / 1000000).toFixed(2)}M`;
      document.getElementById('multiYear').textContent = `$${(multi / 1000000).toFixed(2)}M`;
      document.getElementById('projectionYears').textContent = state.years;
      document.getElementById('yearsValue').textContent = state.years;
      
      // Determine the period description for the summary
      const periodType = document.getElementById('periodType').value;
      const year = document.getElementById('year').value;
      const quarter = document.getElementById('quarter').value;
      let periodDescription = '';

      switch(periodType) {
        case 'quarter':
          periodDescription = `Q${quarter} ${year}`;
          break;
        case 'year':
          periodDescription = `fiscal year ${year}`;
          break;
        case 'ytd':
          periodDescription = `year-to-date ${year}`;
          break;
        case 'custom':
          const startDate = document.getElementById('startDate').value;
          const endDate = document.getElementById('endDate').value;
          if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            periodDescription = `the period from ${start.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} to ${end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
          } else {
            periodDescription = 'the selected period';
          }
          break;
      }
      
      // Update exec summary with dynamic period
      const orgName = document.getElementById('orgName').value || 'Community Care Alliance';
      document.getElementById('execSummary').innerHTML = `
        In ${periodDescription}, <strong>${orgName}</strong> provided community-based care services to <strong>${state.services} clients</strong>, preventing institutional placement and enabling individuals to age in place with dignity. Through our ${scenarios[state.scenario].label.toLowerCase()}, these services generated an estimated <strong style="color: #10b981;">$${(adjusted / 1000000).toFixed(2)} million</strong> in total economic impact to taxpayers and the community.
      `;
      
      updateCharts();
    }
    
    // Scenario selection
    document.querySelectorAll('.scenario-card').forEach(card => {
      card.addEventListener('click', () => {
        document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('active'));
        card.classList.add('active');
        
        state.scenario = card.dataset.scenario;
        state.multiplier = parseFloat(card.dataset.multiplier);
        
        document.getElementById('scenarioDesc').innerHTML = `
          <strong>${scenarios[state.scenario].label}:</strong> ${scenarios[state.scenario].desc}
        `;
        
        updateUI();
      });
    });
    
    // Input handlers (allow manual override after generation)
    document.getElementById('servicesProvided').addEventListener('input', (e) => {
      state.services = parseInt(e.target.value) || 0;
      updateUI();
    });
    
    document.getElementById('avgCost').addEventListener('input', (e) => {
      state.avgCost = parseInt(e.target.value) || 0;
      updateUI();
    });
    
    document.getElementById('yearsRange').addEventListener('input', (e) => {
      state.years = parseInt(e.target.value);
      updateUI();
    });
    
    document.getElementById('orgName').addEventListener('input', updateUI);
    
    // Export PDF with print dialog
    document.getElementById('exportBtn').addEventListener('click', () => {
      // Add a class to body to optimize for print
      document.body.classList.add('printing');
      
      // Small delay to ensure styles are applied
      setTimeout(() => {
        window.print();
        
        // Remove class after print dialog closes
        setTimeout(() => {
          document.body.classList.remove('printing');
        }, 100);
      }, 100);
    });
    
    // Charts
    let cumulativeChart, comparisonChart;
    
    function updateCharts() {
      const { base, adjusted } = calculate();
      
      // Cumulative data
      const yearlyData = Array.from({ length: state.years }, (_, i) => ({
        year: i + 1,
        cumulative: adjusted * (i + 1)
      }));
      
      // Update cumulative chart
      if (cumulativeChart) {
        cumulativeChart.data.labels = yearlyData.map(d => `Year ${d.year}`);
        cumulativeChart.data.datasets[0].data = yearlyData.map(d => d.cumulative);
        cumulativeChart.update();
      } else {
        const ctx1 = document.getElementById('cumulativeChart').getContext('2d');
        cumulativeChart = new Chart(ctx1, {
          type: 'line',
          data: {
            labels: yearlyData.map(d => `Year ${d.year}`),
            datasets: [{
              label: 'Cumulative Impact',
              data: yearlyData.map(d => d.cumulative),
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: (context) => `$${(context.parsed.y / 1000000).toFixed(2)}M`
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: (value) => `$${(value / 1000000).toFixed(1)}M`
                }
              }
            }
          }
        });
      }
      
      // Comparison data
      const comparisonData = [
        { scenario: 'Conservative', value: base * 2.5 },
        { scenario: 'Moderate', value: base * 4.2 },
        { scenario: 'Comprehensive', value: base * 6.8 }
      ];
      
      // Update comparison chart
      if (comparisonChart) {
        comparisonChart.data.datasets[0].data = comparisonData.map(d => d.value);
        comparisonChart.update();
      } else {
        const ctx2 = document.getElementById('comparisonChart').getContext('2d');
        comparisonChart = new Chart(ctx2, {
          type: 'bar',
          data: {
            labels: comparisonData.map(d => d.scenario),
            datasets: [{
              label: 'Annual Impact',
              data: comparisonData.map(d => d.value),
              backgroundColor: [
                'rgba(59, 130, 246, 0.8)',
                'rgba(16, 185, 129, 0.8)',
                'rgba(249, 115, 22, 0.8)'
              ],
              borderColor: [
                'rgba(59, 130, 246, 1)',
                'rgba(16, 185, 129, 1)',
                'rgba(249, 115, 22, 1)'
              ],
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: (context) => `$${(context.parsed.y / 1000000).toFixed(2)}M`
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: (value) => `$${(value / 1000000).toFixed(1)}M`
                }
              }
            }
          }
        });
      }
    }
    
    // Initialize
    updateUI();
  </script>
</body>
</html>