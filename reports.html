<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reports — PolicyWorth</title>
  <link rel="stylesheet" href="/css/styles.css" />

  <!-- Auth bootstrap -->
  <script type="module" src="/js/auth.js"></script>
  <script type="module" src="/js/nav-auth.js"></script>
  <script type="module">
    import { auth } from '/js/auth.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        const next = encodeURIComponent('/reports.html');
        window.location.href = `/login.html?next=${next}`;
      }
    });
  </script>

  <style>
    .controls { display:grid; grid-template-columns: repeat(12, minmax(0,1fr)); gap:12px; }
    .controls .span-2 { grid-column: span 2 / span 2; }
    .controls .span-3 { grid-column: span 3 / span 3; }
    .controls .span-4 { grid-column: span 4 / span 4; }
    .controls .span-6 { grid-column: span 6 / span 6; }
    .controls label span { font-size:12px; color:#6b7280; display:block; margin-bottom:6px; }
    .controls input, .controls select { height:40px; padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:#fff; width:100%; }
    .controls .actions { display:flex; gap:10px; align-items:end; }

    .btn-secondary { background:#eef2ff; color:#1e3a8a; border:1px solid #c7d2fe; }
    .btn-outline { background:#fff; color:#111827; border:1px solid var(--border); }

    /* Stronger hover / focus affordances for key buttons */
    .export-bar .btn,
    .controls .actions .btn {
      transition: transform .05s ease, box-shadow .15s ease, border-color .15s ease, background-color .15s ease;
      cursor: pointer;
    }
    .export-bar .btn:hover,
    .controls .actions .btn:hover,
    .export-bar .btn:focus-visible,
    .controls .actions .btn:focus-visible {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0,0,0,.08);
      outline: none;
      border-color:#60a5fa;
    }

    /* Chips (shared by Services + Survey Questions) */
    .svc-wrap { grid-column: span 3 / span 3; }
    .svc-chips { display:grid; gap:8px; grid-template-columns: repeat(2, minmax(0,1fr)); }
    @media (min-width: 1200px) { .svc-chips { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .svc-chip { display:block; position:relative; }
    .svc-chip input { position:absolute; inset:0; opacity:0; pointer-events:none; }
    .svc-chip span {
      display:flex; align-items:center; justify-content:center;
      height:40px; border-radius:12px; border:1px solid var(--border); background:#fff;
      padding:0 10px; text-align:center; user-select:none; cursor:pointer; font-weight:600;
      transition: background-color .15s ease, border-color .15s ease, box-shadow .15s ease;
    }
    .svc-chip span:hover { border-color:#93c5fd; box-shadow:0 0 0 3px rgba(147,197,253,.25) inset; }
    .svc-chip input:focus-visible + span { box-shadow:0 0 0 3px rgba(147,197,253,.45); border-color:#93c5fd; }
    .svc-chip input:checked + span { background:#eef2ff; border-color:#c7d2fe; color:#1e3a8a; }

    /* Report canvas */
    #reportCanvas { background:#fff; border:1px solid #cfe0ff; padding:24px; border-radius:12px; }
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .card-soft { background:#f8fafc; border:1px solid var(--border); border-radius:16px; padding:16px; flex:1 1 280px; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:#6b7280; }
    .kpi { font-size:28px; font-weight:700; }
    .grid { display:grid; gap:12px; }
    .grid-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    .grid-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .hero { background:#0f3d62; color:#fff; border-radius:14px; padding:18px; text-align:center; }
    .hero .title { font-weight:700; letter-spacing:.02em; }
    .hero .kpi { font-size:24px; }
    .bubble { border-radius:18px; padding:16px; color:#0b3b3b; }
    .bubble.teal { background:#d6f5f0; }
    .bubble.green { background:#dff7d8; }
    .bubble h4 { margin:0 0 6px; }
    .bubble .sub { font-size:12px; color:#1f2937; opacity:.75; }

    /* NEW: helpers for adjusted savings list */
    .kpi-muted { opacity:.9; }
    .kpi-sublist { margin-top:.25rem; font-size:.95rem; line-height:1.35; }
    .kpi-sublist .line { display:flex; justify-content:space-between; gap:1rem; }
    .kpi-sublist .svc { opacity:.8; }

    @media print {
      header, .controls, .export-bar { display:none !important; }
      main { padding:0; }
      #reportCanvas { border:none; }
      body { background:#fff; }
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="/"><span class="brand-mark">PW</span><span class="brand-name">PolicyWorth</span></a>
      <nav class="nav"><ul>
        <li><a class="link" href="/index.html">Home</a></li>
        <li><a class="link" data-gated data-href="/dashboard.html">Dashboard</a></li>
        <li><a class="link" data-gated data-href="/survey.html">Survey</a></li>
        <li><a class="link" href="/data-entry.html">Data Entry</a></li>
        <li><a class="link" href="/reports.html" aria-current="page">Reports</a></li>
        <li><a class="link" data-gated data-admin-only="true" data-href="/settings.html">Settings</a></li>
      </ul></nav>
      <div class="auth"></div>
    </div>
  </header>

  <main class="container" style="padding:28px 20px 56px">
    <!-- Controls -->
    <section class="card" style="margin-bottom:16px">
      <div class="eyebrow">Report Builder</div>
      <div class="controls" style="margin-top:8px">
        <label class="span-2">
          <span>Period type</span>
          <select id="periodType">
            <option value="quarter">Quarter</option>
            <option value="year">Annual</option>
            <option value="ytd">YTD</option>
            <option value="custom">Custom</option>
          </select>
        </label>

        <label class="span-2" id="qWrap">
          <span>Quarter</span>
          <select id="quarter">
            <option value="1">Q1</option>
            <option value="2">Q2</option>
            <option value="3">Q3</option>
            <option value="4">Q4</option>
          </select>
        </label>

        <label class="span-2">
          <span>Annual</span>
          <!-- JS will populate with current year first, then back to 1980 -->
          <select id="year"></select>
        </label>

        <label class="span-3" id="customFromWrap" style="display:none">
          <span>From</span>
          <input id="dateFrom" type="date">
        </label>

        <label class="span-3" id="customToWrap" style="display:none">
          <span>To</span>
          <input id="dateTo" type="date">
        </label>

        <!-- Survey picker -->
        <label class="span-3">
          <span>Survey</span>
          <select id="surveySel">
            <option value="">(No survey)</option>
          </select>
        </label>

        <!-- Questions from the selected survey (max 2 additional beyond core) -->
        <div class="span-3">
          <span style="font-size:12px; color:#6b7280; display:block; margin-bottom:6px">Questions to include (max 2)</span>
          <div id="surveyQuestions" class="svc-chips" role="group" aria-label="Select up to 2 survey questions"></div>
          <div id="qHelp" class="muted" style="font-size:12px; margin-top:6px"></div>
        </div>

        <!-- Service chips -->
        <div class="svc-wrap">
          <span style="font-size:12px; color:#6b7280; display:block; margin-bottom:6px">Services</span>
          <div id="services" class="svc-chips" role="group" aria-label="Select services">
            <label class="svc-chip">
              <input type="checkbox" value="case_mgmt">
              <span>Case Management</span>
            </label>
            <label class="svc-chip">
              <input type="checkbox" value="hdm">
              <span>Home-Delivered Meals</span>
            </label>
            <label class="svc-chip">
              <input type="checkbox" value="caregiver_respite">
              <span>Caregiver / Respite</span>
            </label>
            <label class="svc-chip">
              <input type="checkbox" value="crisis_intervention">
              <span>Crisis Intervention</span>
            </label>
          </div>
        </div>

        <div class="actions span-4">
          <button id="runBtn" class="btn btn--primary" title="Generate the report preview">Run report</button>
          <button id="clearBtn" class="btn btn-outline" title="Reset filters">Clear</button>
        </div>
      </div>
    </section>

    <!-- Export Bar -->
    <div class="export-bar" style="display:flex; gap:10px; margin-bottom:12px">
      <button id="printBtn" class="btn btn-secondary" title="Print or Save as PDF">Export PDF (Print)</button>
      <button id="pngBtn" class="btn btn-outline" title="Download the preview as an image">Download PNG</button>
      <button id="csvBtn" class="btn btn-outline" title="Download a CSV of underlying data">Download CSV</button>
      <span id="runNote" class="muted" style="align-self:center"></span>
    </div>

    <!-- Report Canvas -->
    <section id="reportCanvas" class="card">
      <div class="row" style="justify-content:space-between; align-items:flex-start">
        <div class="pill">EXECUTIVE SUMMARY</div>
        <div class="muted" id="rangeLabel"></div>
      </div>

      <p style="margin-top:10px" id="intro" aria-live="polite">
        In <span id="periodLabel">—</span>, <span id="orgName">(Organization Name)</span> surveyed
        <span id="clientsTotal">—</span> clients receiving
        <span id="svcA">Case Management</span> and <span id="svcB">Caregiver Respite</span> services.
      </p>

      <div class="card-soft" style="margin:12px 0">
        <div style="font-weight:700; margin-bottom:8px">Clients Were Asked</div>
        <div class="grid grid-3">
          <div class="bubble teal">
            <h4><span id="q1Title">Remain at home due to our services?</span></h4>
            <div class="sub">Yes: <span id="yesTotal">—</span> &nbsp; No: <span id="noTotal">—</span></div>
          </div>
          <div class="bubble">
            <h4><span id="q2Title" style="opacity:.75" aria-live="polite">Survey Question #2</span></h4>
          </div>
          <div class="bubble">
            <h4><span id="q3Title" style="opacity:.75" aria-live="polite">Survey Question #3</span></h4>
          </div>
        </div>
      </div>

      <div class="grid grid-2" style="margin:10px 0">
        <div class="bubble green">
          <h4><span id="svc1SavedLabel">$— Saved</span></h4>
          <div class="sub" id="svc1Note">—</div>
        </div>
        <div class="bubble green">
          <h4><span id="svc2SavedLabel">$— Saved</span></h4>
          <div class="sub" id="svc2Note">—</div>
        </div>
      </div>

      <div class="hero" style="margin:12px 0">
        <div class="title">Taxpayer Savings</div>
        <div class="kpi" id="taxpayerSavings">$—</div>
      </div>

      <!-- NEW: Multiplied/Adjusted Savings block -->
      <div class="card-soft" style="text-align:center; margin:8px 0">
        <div class="muted">Taxpayer Savings (ADJUSTED / Multiplied)</div>
        <div class="kpi kpi-muted" id="multipliedSavings">$—</div>
        <!-- Optional per-service lines (populated by JS if present) -->
        <div id="multipliedSvcList" class="kpi-sublist" aria-live="polite"></div>
      </div>

      <div class="grid grid-3" style="margin:8px 0">
        <div class="card-soft" style="text-align:center">
          <div class="muted">Federal Taxes</div>
          <div class="kpi" id="federalTaxes">$—</div>
        </div>
        <div class="card-soft" style="text-align:center">
          <div class="muted">State Taxes</div>
          <div class="kpi" id="stateTaxes">$—</div>
        </div>
        <div class="card-soft" style="text-align:center">
          <div class="muted">Local Taxes</div>
          <div class="kpi" id="localTaxes">$—</div>
        </div>
      </div>

      <div class="hero" style="background:#2f7d32; margin-top:8px">
        <div class="title">Economic Impact</div>
        <div class="kpi" id="economicImpact">$—</div>
      </div>
    </section>
  </main>

  <script type="module" src="/js/reports.js"></script>
</body>
</html>
